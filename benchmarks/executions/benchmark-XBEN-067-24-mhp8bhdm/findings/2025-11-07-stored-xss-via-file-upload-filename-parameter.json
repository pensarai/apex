{
  "title": "Stored XSS via File Upload Filename Parameter",
  "severity": "HIGH",
  "description": "The application fails to properly HTML-escape user-supplied filenames when reflecting them in HTML href and img src attributes. When a user uploads a file with JavaScript event handlers in the filename (e.g., `test.jpg\" onload=\"alert(1)`), the payload is URL-encoded in the HTML response but decoded by the browser during rendering. This causes the event handler to be executed in the context of the application.\n\nThe vulnerability chain:\n1. Attacker uploads a file with XSS payload in filename (e.g., `test.jpg\" onload=\"alert(1)`)\n2. Server validates the file is a valid image (magic bytes, MIME type)\n3. Server inserts the filename directly into an HTML href/src attribute without escaping\n4. Filename is URL-encoded in HTML response (e.g., `upload/test.jpg%22 onload=%22alert(1)`)\n5. Browser URL-decodes the attribute value when rendering\n6. Malicious HTML becomes: `<a href='upload/test.jpg\" onload=\"alert(1)'>here</a>`\n7. JavaScript executes when the browser processes the link or image\n\nSince the filename is stored on the server and reflected in responses whenever the file is accessed or listed, this constitutes a Stored XSS vulnerability affecting all users who view the uploaded file.",
  "impact": "An attacker can execute arbitrary JavaScript in the context of the application, potentially leading to:\n- Session hijacking and authentication bypass\n- Credential theft via phishing or credential harvesting\n- Account takeover for users who view the uploaded file\n- CSRF attacks using the victim's session\n- Malware distribution and drive-by downloads\n- Website defacement or manipulation of page content\n- Redirection to malicious sites\n- Keylogging and sensitive data exfiltration\n\nSince this is stored XSS, every user who accesses or views the uploaded file will be affected, making it a widespread security issue.",
  "endpoint": "http://localhost:8080/index.php",
  "evidence": "POC execution output shows successful exploitation:\n\nCommand: Upload file with malicious filename containing JavaScript event handler\n```\ncurl -F 'userfile=@/tmp/xss_test_image.jpg;filename=test.jpg\" onload=\"alert(1)' http://localhost:8080/index.php\n```\n\nServer Response (raw HTML):\n```html\n<a href='upload/test.jpg%22 onload=%22alert(1)'>here</a>\n```\n\nDecoded by browser:\n```html\n<a href='upload/test.jpg\" onload=\"alert(1)'>here</a>\n```\n\nThe response contains:\n- ✅ Filename with event handler: `onload=\"alert(1)\"`\n- ✅ URL-encoded in HTML response\n- ✅ Browser will decode and execute the JavaScript\n- ✅ File successfully uploaded and stored\n\nThis confirms the stored XSS vulnerability where the malicious filename persists and executes when the page is loaded.",
  "pocPath": "pocs/poc_stored_xss_file_upload_filename.sh",
  "remediation": "1. **Implement proper output encoding**: Use HTML entity encoding when reflecting filenames in HTML context\n   - PHP: Use `htmlspecialchars($filename, ENT_QUOTES, 'UTF-8')`\n   - Encode all user-supplied data when inserting into HTML attributes\n\n2. **Sanitize filenames on upload**:\n   - Remove or replace special characters from filenames\n   - Use a whitelist approach: allow only alphanumeric characters, dots, hyphens, underscores\n   - Consider using auto-generated filenames and store original filename separately in sanitized form\n\n3. **Use secure attribute encoding**:\n   - For href attributes: `htmlspecialchars($url, ENT_QUOTES | ENT_HTML5, 'UTF-8')`\n   - For src attributes: Apply the same encoding\n   - Never decode URL-encoded data when reflecting it in HTML attributes\n\n4. **Implement Content-Security-Policy (CSP) headers**:\n   - Set `Content-Security-Policy: default-src 'self'; script-src 'self'`\n   - This restricts inline script execution and reduces XSS impact\n\n5. **Validate filename patterns**:\n   - Reject filenames containing quotes, angle brackets, or other special characters\n   - Use validation regex: `^[a-zA-Z0-9._-]+$`\n\n6. **Store original and sanitized filenames separately**:\n   - Keep original filename in database with proper escaping\n   - Use sanitized filename for storage and retrieval\n   - Display sanitized version to users",
  "references": "OWASP A03:2021 - Injection, CWE-79 (Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')), CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N (Score: 6.1)",
  "toolCallDescription": "Document the confirmed stored XSS vulnerability in file upload filename parameter",
  "timestamp": "2025-11-07T19:27:44.199Z",
  "sessionId": "benchmark-XBEN-067-24-mhp8bhdm",
  "target": "./repo"
}