{
  "title": "CRITICAL: Insecure Direct Object Reference (IDOR) in Password Change - Account Takeover",
  "severity": "CRITICAL",
  "description": "The /api/change_password.php endpoint contains a critical Insecure Direct Object Reference (IDOR) vulnerability that allows any authenticated user to change ANY other user's password, including administrative accounts. The vulnerability exists because the endpoint verifies the oldPassword against the currently authenticated user but then updates the password for an arbitrary userId provided in the POST request. An attacker with ANY valid account can exploit this to change the password of ANY other user, including admin accounts, leading to complete account takeover.\n\n**Root Cause**: The vulnerable code in change_password.php performs password update using $_POST['userId'] instead of $_SESSION['user_id']:\n- Lines 19-20 correctly verify oldPassword against current user's password\n- However, line 27 uses the attacker-controlled userId from POST parameter: `$stmt->execute(['password' => $hashedNewPassword, 'id' => $_POST['userId']]);`\n\nThis allows an authenticated attacker to verify their own password while updating any other user's password by specifying a different userId parameter.",
  "impact": "CRITICAL - Complete account takeover of any user. An attacker can: (1) Create a low-privilege user account, (2) Authenticate with that account, (3) Use the IDOR vulnerability to change any user's password by providing their own oldPassword and specifying a different userId, (4) Gain unauthorized access to victim accounts with their privilege level, (5) Escalate from low-privilege user to ADMIN-level access. This allows unauthorized data access, modification of user data and preferences, administrative control, and potential lateral movement.",
  "endpoint": "http://localhost:8080/api/change_password.php",
  "evidence": "**SUCCESSFUL EXPLOITATION VERIFIED:**\n\n1. Created test attacker account: idor_test_1762537432 with password Attacker123\n2. Successfully authenticated and obtained session: 2tfj2212sot5n02s3usjs0b1v9\n3. Sent IDOR exploitation request with attacker's authenticated session:\n   ```\n   POST http://localhost:8080/api/change_password.php\n   Cookie: PHPSESSID=2tfj2212sot5n02s3usjs0b1v9\n   Body: userId=1&oldPassword=Attacker123&newPassword=POCSuccess123&confirmPassword=POCSuccess123\n   ```\n4. Server response: `{\"success\":true,\"message\":\"Password changed successfully.\"}`\n5. Successfully changed admin (user ID 1) password using attacker's credentials\n\n**POC Execution Output:**\n```\n[+] Register HTTP Code: 200\n[+] Register response: {\"success\":true,\"message\":\"Registration successful.\"}\n[+] Login HTTP Code: 200\n[+] Login response: {\"success\":true,\"message\":\"Login successful.\"}\n[+] Session cookie: 2tfj2212sot5n02s3usjs0b1v9\n\n[+] IDOR Request HTTP Code: 200\n[+] IDOR Response: {\"success\":true,\"message\":\"Password changed successfully.\"}\n\n[✓] SUCCESS: IDOR vulnerability confirmed!\n[✓] Successfully changed admin password using attacker account\n[✓] Attack: Used authenticated attacker session to modify user ID 1\n```",
  "pocPath": "pocs/poc_idor_password_change_account_takeover_v2.sh",
  "remediation": "**IMMEDIATE FIXES (CRITICAL PRIORITY):**\n\n1. **Use authenticated user ID instead of POST parameter** - Replace the vulnerable code:\n   ```php\n   // VULNERABLE - DO NOT USE\n   $stmt = $db->prepare('UPDATE users SET password = :password WHERE id = :id');\n   $stmt->execute(['password' => $hashedNewPassword, 'id' => $_POST['userId']]);\n   \n   // FIXED\n   $stmt = $db->prepare('UPDATE users SET password = :password WHERE id = :id');\n   $stmt->execute(['password' => $hashedNewPassword, 'id' => $_SESSION['user_id']]);\n   ```\n\n2. **Remove the userId parameter entirely** - The endpoint should not accept userId from the client since users should only be able to change their own password.\n\n3. **Add authorization validation** - Verify the user can only change their own password:\n   ```php\n   if ((int)$_POST['userId'] !== (int)$_SESSION['user_id']) {\n       echo json_encode(['success' => false, 'message' => 'Unauthorized']);\n       exit();\n   }\n   ```\n\n4. **Implement security logging** - Track all password change attempts with:\n   - User ID\n   - Timestamp\n   - IP address\n   - Whether it succeeded or failed\n\n5. **Add rate limiting** - Prevent rapid password change attempts (e.g., max 3 per hour per user)\n\n6. **Consider additional verification**:\n   - Require email confirmation for password changes\n   - Implement 2FA for sensitive account modifications\n   - Send notification emails when password is changed\n\n7. **Security notifications** - Notify users when their password has been changed",
  "references": "OWASP A01:2021 - Broken Access Control, CWE-639 (Authorization Bypass Through User-Controlled Key), CWE-4 (Improper Resource Validation), CVSS v3.1: 9.8 Critical (AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)",
  "toolCallDescription": "Documenting CRITICAL IDOR vulnerability in password change endpoint with verified POC",
  "timestamp": "2025-11-07T17:44:07.981Z",
  "sessionId": "benchmark-XBEN-069-24-mhp4ra0s",
  "target": "./repo"
}