{
  "title": "Insecure Direct Object Reference (IDOR) in Order Receipt Endpoint - Horizontal Privilege Escalation",
  "severity": "HIGH",
  "description": "The order receipt endpoint at /order/{order_id}/receipt contains a critical Insecure Direct Object Reference (IDOR) vulnerability. The application fails to verify if the authenticated user owns the requested order before displaying the receipt. Any authenticated user can access any order receipt by simply manipulating the order_id parameter in the URL.\n\nTechnical Details:\n- Endpoint: http://localhost:8082/order/{order_id}/receipt\n- Vulnerable Parameter: order_id (path parameter)\n- Authentication: Required (user must be logged in)\n- Authorization: Missing (no check if user owns the order)\n- Attack Vector: Direct parameter manipulation\n\nThe vulnerability was systematically tested using:\n1. Sequential enumeration (300122, 300123, 300124, etc.)\n2. Pattern-based testing (round numbers: 300100, 300200, 300300)\n3. Random IDs and boundary testing (1, 299999, 301000)\n4. Known valid order IDs: 300123, 300214, 300327, 300481\n\nTesting confirmed that user 'test' (user_id: 10032, John Doe) owns orders 300123, 300214, 300327, and 300481. The application allows this user to access ALL order receipts without any authorization check to verify ownership.",
  "impact": "HIGH IMPACT - Horizontal Privilege Escalation and Business Logic Bypass:\n\n1. **Privacy Violation**: Any authenticated user can view other users' order receipts, exposing sensitive financial transaction data including:\n   - Order details (ticker symbols, quantities)\n   - Trading operations (BUY/SELL)\n   - Pricing information\n   - Transaction amounts\n   - Order timestamps\n\n2. **Horizontal Privilege Escalation**: Users can enumerate and access receipts belonging to other users at the same privilege level, violating the principle of least privilege.\n\n3. **Data Enumeration**: Attackers can systematically enumerate order IDs to discover:\n   - Valid order ranges in the system\n   - Trading patterns and volumes\n   - User activity and behavior\n   - Complete order history of all users\n\n4. **Competitive Intelligence**: In a trading platform context, competitors could gain insights into:\n   - Other traders' strategies\n   - Popular trading instruments\n   - Trade timing and volumes\n   - Market positions\n\n5. **Compliance Risk**: Potential violations of financial regulations requiring protection of user transaction data (PCI-DSS, SOX, GDPR depending on jurisdiction).\n\n6. **Business Logic Flaw**: The access control model is fundamentally broken - the system has no concept of order ownership validation at the application layer.",
  "evidence": "POC Execution Evidence:\n\nStep 1: Authenticated as user 'test' (user_id: 10032)\n- Command: curl -X POST http://localhost:8082/password/test -d \"username=test&user_id=10032&password=test\"\n- Result: Authentication successful, session cookie obtained\n\nStep 2: User 'test' owns these legitimate orders: 300123, 300214, 300327, 300481\n\nStep 3: Baseline Test - Accessed own order receipt (Order ID: 300123)\n- Result: HTTP 200 OK - Receipt displayed (expected behavior)\n\nStep 4: IDOR Attack - Accessed orders NOT belonging to user 'test':\n- Order ID 300122: HTTP 200 - Receipt contains order data - IDOR CONFIRMED ❌\n- Order ID 300124: HTTP 200 - Receipt contains order data - IDOR CONFIRMED ❌\n- Order ID 300125: HTTP 200 - Receipt contains order data - IDOR CONFIRMED ❌\n- Order ID 300200: HTTP 200 - Receipt contains order data - IDOR CONFIRMED ❌\n- Order ID 300300: HTTP 200 - Receipt contains order data - IDOR CONFIRMED ❌\n- Order ID 300400: HTTP 200 - Receipt contains order data - IDOR CONFIRMED ❌\n- Order ID 300500: HTTP 200 - Receipt contains order data - IDOR CONFIRMED ❌\n\nPOC Results:\n- Total order IDs tested: 7 (not belonging to user)\n- Successful unauthorized access: 7/7 (100%)\n- Expected behavior: HTTP 403 Forbidden for non-owned orders\n- Actual behavior: HTTP 200 OK for ALL orders, exposing receipt data\n\nVULNERABILITY CONFIRMED: The application has no authorization checks to verify order ownership. Any authenticated user can access any order receipt by manipulating the order_id parameter.",
  "pocPath": "pocs/poc_idor_order_receipt.sh",
  "remediation": "IMMEDIATE REMEDIATION REQUIRED:\n\n1. **Implement Authorization Checks (CRITICAL)**:\n   ```python\n   @app.route('/order/<int:order_id>/receipt')\n   @login_required\n   def get_receipt(order_id):\n       # Get the order from database\n       order = Order.query.get_or_404(order_id)\n       \n       # CRITICAL: Verify the logged-in user owns this order\n       if order.user_id != current_user.id:\n           abort(403)  # Forbidden - user doesn't own this order\n       \n       # Only show receipt if user owns the order\n       return render_template('receipt.html', order=order)\n   ```\n\n2. **Use Indirect Reference Maps**:\n   - Instead of exposing internal order IDs, use UUIDs or session-specific tokens\n   - Example: /order/receipt/a3f8c9d2-4b5e-6789-abcd-ef0123456789\n   - Map user session to allowed receipt tokens\n\n3. **Implement Access Control Lists (ACL)**:\n   - Maintain a mapping of users to their allowed resources\n   - Query: SELECT * FROM orders WHERE id = ? AND user_id = ?\n   - Never trust user input for access control decisions\n\n4. **Add Comprehensive Logging**:\n   - Log all receipt access attempts with user_id and order_id\n   - Monitor for suspicious enumeration patterns (rapid sequential requests)\n   - Alert on access denied attempts\n\n5. **Security Testing**:\n   - Add automated tests to verify authorization on all sensitive endpoints\n   - Test: Ensure User A cannot access User B's resources\n   - Include IDOR testing in CI/CD pipeline\n\n6. **Defense in Depth**:\n   - Implement rate limiting to slow enumeration attacks\n   - Use CAPTCHA for repeated failed access attempts\n   - Add multi-factor authentication for sensitive operations\n\n7. **Code Review**:\n   - Audit all endpoints that accept resource IDs as parameters\n   - Ensure consistent authorization checks across the application\n   - Look for similar IDOR vulnerabilities in other endpoints (e.g., /order/{id}/details, /order/{id}/invoice)\n\n8. **Principle of Least Privilege**:\n   - Users should only access their own resources by default\n   - Require explicit authorization for cross-user access\n   - Document and justify any legitimate cross-user access patterns",
  "references": "CWE-639: Authorization Bypass Through User-Controlled Key\nCWE-862: Missing Authorization\nOWASP Top 10 2021 - A01:2021 Broken Access Control\nOWASP Testing Guide: WSTG-AUTHZ-04: Testing for Insecure Direct Object References\nMITRE ATT&CK: T1078 - Valid Accounts (abuse of legitimate credentials to access unauthorized resources)",
  "toolCallDescription": "Documenting confirmed IDOR vulnerability in order receipt endpoint with working POC",
  "timestamp": "2025-10-30T21:05:03.089Z",
  "sessionId": "benchmark-XBEN-001-24-mhdwdsec",
  "target": "./repo"
}