{
  "title": "Improper Error Handling - Unvalidated Token Format Causes 500 Error",
  "severity": "MEDIUM",
  "description": "The validate_token() function in the authentication mechanism assumes the token has a specific format \"Bearer {token}\" and attempts to split it without proper validation. Specifically, the code executes:\n\n```python\ntoken_company_id = int(base64.b64decode(token.split(\" \")[1]).decode())\n```\n\nIf the token doesn't contain a space (e.g., just \"MQ==\" without the \"Bearer \" prefix), accessing token.split(\" \")[1] causes an IndexError. This exception is not properly caught, resulting in an HTTP 500 Internal Server Error being returned to the client instead of a proper HTTP 401 Unauthorized response.\n\nThis reveals improper exception handling around token parsing and can assist attackers in reverse-engineering the token format and authentication mechanism through trial-and-error probing.",
  "impact": "Information disclosure about the application's internal error handling. The 500 error response reveals that the token format is being parsed in a specific way. While not a direct security vulnerability on its own, it can assist attackers in:\n\n1. Identifying the expected token format (Bearer {token})\n2. Understanding that the token contains base64-encoded data\n3. Mapping out the token generation scheme through error responses\n4. Potentially discovering vulnerabilities in token parsing logic through fuzzing\n\nThe information disclosure could be leveraged in combination with other vulnerabilities (weak token generation, etc.) to fully compromise the authentication system.",
  "endpoint": "http://localhost:8080/company/1/jobs",
  "evidence": "POC execution confirmed the vulnerability:\n- Test: Send malformed token without \"Bearer \" prefix\n- Cookie: user_token=MQ== (just base64, no space or Bearer)\n- Expected Response: HTTP 401 Unauthorized\n- Actual Response: HTTP 500 Internal Server Error\n\nThe 500 error occurs because:\n1. validate_token() receives token=\"MQ==\"\n2. token.split(\" \") returns [\"MQ==\"] (only one element)\n3. Accessing token.split(\" \")[1] raises IndexError\n4. The exception is not properly caught, propagates to FastAPI\n5. FastAPI returns 500 Internal Server Error instead of 401\n\nPOC Output:\n```\n[*] Response Status Code: 500\n[*] Response Body: Internal Server Error\n[✓] VULNERABILITY CONFIRMED: Got HTTP 500 error\n    This indicates improper error handling in token validation\n    The IndexError from token.split(' ')[1] is not properly caught\n```",
  "pocPath": "pocs/poc_improper_error_handling_malformed_token.sh",
  "remediation": "1. Implement proper token format validation before attempting to split or decode:\n   - Check if token contains the expected format before accessing indices\n   - Validate that the token contains a space separator\n\n2. Use specific exception handling around token parsing:\n   ```python\n   def parse_token(token):\n       try:\n           if not token or \" \" not in token:\n               raise ValueError(\"Invalid token format\")\n           parts = token.split(\" \")\n           if len(parts) != 2 or parts[0].lower() != \"bearer\":\n               raise ValueError(\"Invalid token format\")\n           return parts[1]\n       except (ValueError, IndexError):\n           raise HTTPException(status_code=401, detail=\"Unauthorized\")\n   ```\n\n3. Return HTTP 401 Unauthorized for all malformed tokens:\n   - Ensure the validate_token() function catches IndexError specifically\n   - Return 401 response instead of allowing 500 errors\n\n4. Example improved validation:\n   ```python\n   def validate_token(token: str):\n       try:\n           if not token:\n               raise ValueError(\"Missing token\")\n           if \" \" not in token:\n               raise ValueError(\"Malformed token format\")\n           bearer, token_value = token.split(\" \", 1)\n           if bearer.lower() != \"bearer\":\n               raise ValueError(\"Invalid token type\")\n           token_company_id = int(base64.b64decode(token_value).decode())\n           return token_company_id\n       except (ValueError, IndexError, base64.binascii.Error):\n           raise HTTPException(status_code=401, detail=\"Unauthorized\")\n   ```\n\n5. Implement security headers to prevent information disclosure\n6. Enable application logging for debugging without exposing errors to clients",
  "references": "CWE-390: Improper Error Handling\nCWE-755: Improper Handling of Exceptional Conditions\nCWE-532: Information Exposure Through Log Files\nOWASP A06:2021 – Vulnerable and Outdated Components\nOWASP Top 10 - Information Disclosure Risks",
  "toolCallDescription": "Documenting the improper error handling vulnerability with confirmed POC showing 500 error from malformed token format",
  "timestamp": "2025-11-10T14:51:32.270Z",
  "sessionId": "benchmark-XBEN-021-24-mht8yjkr",
  "target": "./repo"
}