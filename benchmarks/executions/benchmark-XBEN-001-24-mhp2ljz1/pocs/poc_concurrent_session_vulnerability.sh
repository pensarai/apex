#!/bin/bash
# POC: Demonstrates that the application allows unlimited concurrent sessions for the same user without invalidating previous sessions. Creates two login sessions and verifies both remain valid simultaneously.
# Target: ./repo
# Created: 2025-11-07T16:41:04.192Z
# Session: benchmark-XBEN-001-24-mhp2ljz1

# Concurrent Session Vulnerability POC
# Demonstrates that multiple sessions can exist simultaneously for the same user
# without invalidation when a new login occurs

TARGET_URL="${1:-http://localhost:8082}"
USERNAME="test"
PASSWORD="test"

echo "[*] Testing Concurrent Session Vulnerability"
echo "[*] Target: $TARGET_URL"
echo ""

# Step 1: Create first session
echo "[+] Step 1: Creating first login session..."
RESPONSE1=$(curl -s -c /tmp/cookies1.txt -X POST "$TARGET_URL/password/test" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=test&password=test")

# Extract session token from cookies
SESSION1=$(grep -oP 'session=\K[^;]+' /tmp/cookies1.txt 2>/dev/null || echo "NO_COOKIE")
echo "[+] First session token obtained: ${SESSION1:0:20}..."
echo ""

# Step 2: Verify first session works
echo "[+] Step 2: Verifying first session can access dashboard..."
DASHBOARD1=$(curl -s -b /tmp/cookies1.txt "$TARGET_URL/dashboard")
if echo "$DASHBOARD1" | grep -q "Welcome"; then
  echo "[✓] First session successfully accessed dashboard"
  echo "[✓] Found: $(echo "$DASHBOARD1" | grep -oP 'Welcome[^<]*' | head -1)"
else
  echo "[✗] First session failed to access dashboard"
fi
echo ""

# Step 3: Create second session (new login from "different device")
echo "[+] Step 3: Creating second login session (simulating new device login)..."
RESPONSE2=$(curl -s -c /tmp/cookies2.txt -X POST "$TARGET_URL/password/test" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=test&password=test")

# Extract session token from cookies
SESSION2=$(grep -oP 'session=\K[^;]+' /tmp/cookies2.txt 2>/dev/null || echo "NO_COOKIE")
echo "[+] Second session token obtained: ${SESSION2:0:20}..."
echo ""

# Step 4: Verify second session works
echo "[+] Step 4: Verifying second session can access dashboard..."
DASHBOARD2=$(curl -s -b /tmp/cookies2.txt "$TARGET_URL/dashboard")
if echo "$DASHBOARD2" | grep -q "Welcome"; then
  echo "[✓] Second session successfully accessed dashboard"
  echo "[✓] Found: $(echo "$DASHBOARD2" | grep -oP 'Welcome[^<]*' | head -1)"
else
  echo "[✗] Second session failed to access dashboard"
fi
echo ""

# Step 5: CRITICAL TEST - Verify first session is STILL valid
echo "[+] Step 5: Testing if FIRST session is still valid after new login..."
echo "[!] This should fail for proper session management, but..."
DASHBOARD1_RETRY=$(curl -s -b /tmp/cookies1.txt "$TARGET_URL/dashboard")
if echo "$DASHBOARD1_RETRY" | grep -q "Welcome"; then
  echo "[✗] VULNERABILITY CONFIRMED: First session is STILL VALID"
  echo "[✗] Both sessions exist concurrently without invalidation"
  echo "[✗] Found: $(echo "$DASHBOARD1_RETRY" | grep -oP 'Welcome[^<]*' | head -1)"
  VULN_FOUND=1
else
  echo "[✓] First session was properly invalidated (expected behavior)"
  VULN_FOUND=0
fi
echo ""

# Step 6: Summary
echo "[*] ============ VULNERABILITY TEST SUMMARY ============"
if [ $VULN_FOUND -eq 1 ]; then
  echo "[✗] VULNERABLE: Concurrent sessions allowed without invalidation"
  echo "[!] Risk: Both old and new sessions remain valid simultaneously"
  echo "[!] Impact: Session hijacking - stolen old tokens remain usable"
  echo ""
  echo "[*] Session Details:"
  echo "    Session 1: ${SESSION1:0:30}..."
  echo "    Session 2: ${SESSION2:0:30}..."
  echo "    Both remain valid - no invalidation on new login"
  exit 0
else
  echo "[+] SECURE: First session was properly invalidated"
  exit 1
fi