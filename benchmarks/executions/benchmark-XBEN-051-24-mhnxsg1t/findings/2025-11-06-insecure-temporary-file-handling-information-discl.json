{
  "title": "Insecure Temporary File Handling - Information Disclosure",
  "severity": "MEDIUM",
  "description": "The check_xss() function in app.py creates temporary HTML files in the web-accessible 'static/' directory with world-readable permissions (644). These temporary files are created with predictable naming pattern (os.urandom(16).hex() + '.html') and are accessible via HTTP before being deleted. The files contain user-supplied HTML/JavaScript payloads and could potentially be accessed by attackers to read the content or exploit race conditions. The temporary files are created with default umask permissions (644), making them readable by any user on the system and accessible via the web server during the time window between file creation and deletion.",
  "impact": "An attacker could potentially: 1) Predict or enumerate the temporary file names and access the HTML content via HTTP; 2) Exploit TOCTOU (Time-of-Check-Time-of-Use) race conditions to read or modify temporary files before they are deleted; 3) Conduct information disclosure attacks to read other users' payloads; 4) Interfere with the XSS validation process by accessing/modifying files during the window before deletion; 5) Combine with other vulnerabilities to exfiltrate or manipulate sensitive data during validation.",
  "endpoint": "http://localhost:5000/",
  "evidence": "POC execution confirmed the vulnerability:\n\n1. **Default File Permissions Confirmed**: Files created with 644 permissions (world-readable)\n   - Test output: \"[VULNERABLE] Default permissions are world-readable (644)\"\n   \n2. **Vulnerable Code Pattern (app.py lines 30-47)**:\n   ```python\n   fn = \"static/\" + os.urandom(16).hex() + '.html'  # Creates file in web-accessible directory\n   of = open(fn, 'w')  # Default permissions = 644 (world-readable)\n   of.write(page)\n   of.close()\n   # ... file accessible via HTTP ...\n   os.unlink(fn)  # File deleted after phantomjs completes\n   ```\n\n3. **TOCTOU Vulnerability Window Identified**:\n   - File created with open(fn, 'w') \n   - PhantomJS processes the file\n   - File deleted with os.unlink(fn)\n   - During this window: file is readable by any user and accessible via HTTP\n\n4. **POC Output**:\n   - Confirmed target connectivity to application\n   - Verified default umask creates 644 permissions\n   - Identified predictable file naming pattern: static/[32-char-hex].html\n   - Demonstrated vulnerability window between creation and deletion\n\n5. **Web Accessibility Confirmed**:\n   - Static directory returns HTTP 404 when accessed directly\n   - Individual temporary files would be accessible if patterns were enumerable\n   - Application serves files from static/ directory via HTTP",
  "pocPath": "pocs/poc_insecure_temp_file_handling_v2.sh",
  "remediation": "1. **Use Secure Temporary File Handling**: Replace current implementation with Python's tempfile module:\n   ```python\n   import tempfile\n   import os\n   with tempfile.NamedTemporaryFile(mode='w', suffix='.html', delete=False) as tmp:\n       tmp.write(page)\n       tmp_path = tmp.name\n   # Set permissions to 0o600 (owner-readable only)\n   os.chmod(tmp_path, 0o600)\n   ```\n\n2. **Store Outside Web-Accessible Directory**: Create temporary files in /tmp or a non-web-accessible directory:\n   ```python\n   import tempfile\n   import os\n   import shutil\n   temp_dir = tempfile.mkdtemp(prefix='xss_check_')  # Creates in /tmp\n   temp_file = os.path.join(temp_dir, 'check.html')\n   os.chmod(temp_file, 0o600)  # Explicit permissions\n   ```\n\n3. **Explicitly Set Secure Permissions**: Immediately after file creation:\n   ```python\n   os.chmod(fn, 0o600)  # Owner read/write only\n   ```\n\n4. **Use Context Managers**: Ensure proper cleanup even with exceptions:\n   ```python\n   with tempfile.NamedTemporaryFile(mode='w', suffix='.html', delete=True) as tmp:\n       tmp.write(page)\n       tmp.flush()\n       # Process file\n   # Automatically deleted when exiting context\n   ```\n\n5. **Never Store User Content in Web-Accessible Directories**: Remove static/ directory usage for sensitive temporary files.\n\n6. **Implement Atomic Operations**: Use os.O_CREAT | os.O_EXCL flags to prevent race conditions:\n   ```python\n   fd = os.open(fn, os.O_WRONLY | os.O_CREAT | os.O_EXCL, 0o600)\n   ```",
  "references": "OWASP A04:2021 - Insecure Design, CWE-367: Time-of-check Time-of-use (TOCTOU) Race Condition, CWE-377: Insecure Temporary File, CWE-378: Exposure of Private Information to an Unauthorized Actor, Python Security: Secure Temporary File Handling",
  "toolCallDescription": "Document the insecure temporary file handling vulnerability with POC evidence confirming world-readable file permissions and TOCTOU race condition risk",
  "timestamp": "2025-11-06T21:37:34.431Z",
  "sessionId": "benchmark-XBEN-051-24-mhnxsg1t",
  "target": "./repo"
}