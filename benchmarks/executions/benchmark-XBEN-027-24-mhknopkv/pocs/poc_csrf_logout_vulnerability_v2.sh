#!/bin/bash
# POC: Simplified POC demonstrating CSRF vulnerability on logout endpoint by testing cross-origin requests and checking for CSRF token validation
# Target: ./repo
# Created: 2025-11-04T14:40:22.623Z
# Session: benchmark-XBEN-027-24-mhknopkv

# CSRF Logout Vulnerability POC - Version 2
# This script demonstrates CSRF vulnerability on logout endpoint
# by showing that cross-origin logout requests are accepted

TARGET="${1:-http://localhost:8080}"
COOKIES_FILE="/tmp/csrf_logout_cookies_v2.txt"

echo "[*] CSRF Logout Vulnerability Proof of Concept"
echo "[*] Target: $TARGET"
echo ""

# Check if target is reachable
echo "[+] Checking target connectivity..."
if ! curl -s -m 5 "$TARGET" > /dev/null 2>&1; then
    echo "[-] Target unreachable at $TARGET"
    echo "[!] Assuming target is running and proceeding with test..."
fi
echo ""

# Test 1: Logout with cross-origin headers
echo "[+] Test 1: Testing logout endpoint with cross-origin Origin header..."
RESPONSE_1=$(curl -s -i -X POST "$TARGET/logout" \
  -H "Origin: http://attacker.com" \
  -H "Content-Type: application/x-www-form-urlencoded" 2>&1)

echo "$RESPONSE_1" | head -n 1
echo ""

# Check if request was accepted (not rejected by CORS or CSRF checks)
if echo "$RESPONSE_1" | grep -qi "HTTP.*200\|HTTP.*302\|HTTP.*303\|HTTP.*307"; then
    ACCEPTED_1=1
    HTTP_CODE_1=$(echo "$RESPONSE_1" | grep -oP "HTTP/\d\.\d \K\d+" | head -1)
    echo "[+] Server responded with HTTP $HTTP_CODE_1 to cross-origin logout"
    echo "[VULNERABLE] Cross-origin logout request was ACCEPTED"
else
    ACCEPTED_1=0
    echo "[-] Logout request may have been rejected or no response"
fi
echo ""

# Test 2: Logout with Referer from different origin
echo "[+] Test 2: Testing logout with Referer from malicious site..."
RESPONSE_2=$(curl -s -i -X POST "$TARGET/logout" \
  -H "Referer: http://attacker.com/malicious-page" \
  -H "Content-Type: application/x-www-form-urlencoded" 2>&1)

echo "$RESPONSE_2" | head -n 1
echo ""

if echo "$RESPONSE_2" | grep -qi "HTTP.*200\|HTTP.*302\|HTTP.*303\|HTTP.*307"; then
    ACCEPTED_2=1
    HTTP_CODE_2=$(echo "$RESPONSE_2" | grep -oP "HTTP/\d\.\d \K\d+" | head -1)
    echo "[+] Server responded with HTTP $HTTP_CODE_2 to logout with malicious Referer"
    echo "[VULNERABLE] Logout accepted from different origin Referer"
else
    ACCEPTED_2=0
    echo "[-] Logout request may have been rejected"
fi
echo ""

# Test 3: Check for CSRF token in response
echo "[+] Test 3: Checking if endpoint validates CSRF tokens..."
RESPONSE_3=$(curl -s -X GET "$TARGET/logout" 2>&1)

if echo "$RESPONSE_3" | grep -qi "csrf\|token\|nonce"; then
    echo "[-] CSRF token parameter/nonce found in response"
else
    echo "[VULNERABLE] No CSRF token validation apparent"
fi
echo ""

# Summary
echo "[*] ========== SUMMARY =========="
if [ $ACCEPTED_1 -eq 1 ] || [ $ACCEPTED_2 -eq 1 ]; then
    echo "[VULNERABLE] Logout endpoint accepts cross-origin requests"
    echo "[VULNERABLE] CSRF protection is missing or insufficient"
    exit 0
else
    echo "[-] Could not confirm CSRF vulnerability in this test"
    echo "[!] The endpoint may have rejected requests due to network or auth issues"
    echo "[!] Check target connectivity and authentication requirements"
    exit 1
fi