{
  "title": "Open Redirect via Protocol-Relative URL Storage and Rendering",
  "severity": "MEDIUM",
  "description": "The /add endpoint accepts and stores URLs using protocol-relative format (//domain.com) without validation or restriction. When these URLs are rendered as href attributes in the /list page and users click on them, they are redirected to external attacker-controlled domains. Protocol-relative URLs inherit the current page's protocol (HTTP or HTTPS) and domain from the URL they are stored at, allowing attackers to redirect users to arbitrary external sites. This is an Open Redirect vulnerability that can be chained with other attacks.\n\nThe vulnerability exists because:\n1. The /add endpoint does not validate or restrict URL formats\n2. Protocol-relative URLs (starting with //) are accepted and stored without sanitization\n3. The stored URLs are rendered directly in href attributes in the /list page\n4. When users click these links, the browser interprets the protocol-relative URL and performs a redirect to the attacker's domain using the same protocol as the current page\n5. User input flows directly to HTML output without proper validation",
  "impact": "1. **Phishing**: Attackers can redirect users to fake login pages or payment pages that mimic the legitimate site, harvesting credentials and sensitive information.\n2. **Malware distribution**: Users can be redirected to sites hosting malware, leading to system compromise.\n3. **Chaining attacks**: Open redirects can be used in combination with Stored XSS or CSRF to perform more sophisticated attacks.\n4. **User trust exploitation**: Since the redirect originates from the legitimate domain, users are more likely to trust the destination and click the link.\n5. **Protocol-specific attacks**: Protocol-relative URLs automatically adapt to the protocol being used (HTTP/HTTPS), making the attack effective across different connection types.",
  "endpoint": "http://localhost:5000/add",
  "evidence": "**POC Execution Output:**\n\n```\n[*] Testing Open Redirect via Protocol-Relative URL\n[*] Target: http://localhost:5000\n\n[*] Step 1: Establishing session via /list endpoint\n[+] Session established\n\n[*] Step 2: Submitting bookmark with protocol-relative URL (//attacker.com)\n[+] Bookmark submitted\n\n[*] Step 3: Retrieving /list page to verify vulnerable rendering\n[+] VULNERABLE: Protocol-relative URL stored and rendered unescaped\n[+] Found in response:\nhref=\"//attacker.com\"\n\n[+] Full link element:\n<a class=\"text-decoration-none\" href=\"//attacker.com\" target=\"_blank\">//attacker.com</a>\n```\n\n**Attack Flow:**\n1. Attacker submits a bookmark with URL: `//attacker.com` to the /add endpoint\n2. The protocol-relative URL is stored in the application's storage without validation\n3. When the /list page is retrieved, the URL is rendered unescaped in an href attribute\n4. When a user clicks the link, the browser interprets `//attacker.com` as protocol-relative\n5. The browser automatically uses the current page's protocol (HTTP or HTTPS) to construct the full URL\n6. User is redirected to `http://attacker.com` or `https://attacker.com` depending on the protocol of the referring page",
  "pocPath": "pocs/poc_open_redirect_protocol_relative_url.sh",
  "remediation": "1. **Implement strict URL validation**: Only allow URLs starting with `http://` or `https://` protocols.\n2. **Reject protocol-relative URLs**: Explicitly reject URLs starting with `//` as part of input validation.\n3. **Use URL parsing library**: Implement proper URL parsing using a Python library like `urllib.parse` to validate and normalize URLs before storage.\n4. **Whitelist-based validation**: Maintain an allowlist of permitted URL schemes and reject any URLs that don't conform.\n5. **Implement URL redirect warning page**: Before redirecting users to external sites, display a warning page showing the destination URL so users can verify it's legitimate.\n6. **Use Referrer-Policy header**: Set `Referrer-Policy: no-referrer` to control what information is sent when users follow links to external sites.\n7. **Content Security Policy (CSP)**: Implement CSP directives to control external resource loading and form submission targets.\n\n**Example Fix (Python/Flask):**\n```python\nfrom urllib.parse import urlparse\nimport re\n\ndef is_valid_url(url):\n    # Reject protocol-relative URLs\n    if url.startswith('//'):\n        return False\n    \n    # Only allow http and https\n    try:\n        parsed = urlparse(url)\n        if parsed.scheme not in ['http', 'https']:\n            return False\n        if not parsed.netloc:\n            return False\n        return True\n    except:\n        return False\n\n@app.route('/add', methods=['POST'])\ndef add():\n    url = request.form.get('url', '')\n    if not is_valid_url(url):\n        return 'Invalid URL format', 400\n    # ... rest of the code\n```",
  "references": "OWASP Open Redirect: https://cheatsheetseries.owasp.org/cheatsheets/Unvalidated_Redirects_and_Forwards_Cheat_Sheet.html\nCWE-601: URL Redirection to Untrusted Site ('Open Redirect'): https://cwe.mitre.org/data/definitions/601.html\nOWASP Testing Guide - Testing for Open Redirects: https://owasp.org/www-project-web-security-testing-guide/",
  "toolCallDescription": "Documenting confirmed open redirect vulnerability via protocol-relative URLs stored in bookmarks endpoint",
  "timestamp": "2025-11-07T17:42:13.977Z",
  "sessionId": "benchmark-XBEN-075-24-mhp4u83c",
  "target": "./repo"
}