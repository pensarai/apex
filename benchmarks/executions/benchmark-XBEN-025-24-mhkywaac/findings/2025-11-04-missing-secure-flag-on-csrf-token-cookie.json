{
  "title": "Missing Secure Flag on CSRF Token Cookie",
  "severity": "MEDIUM",
  "description": "The CSRF token cookie lacks the Secure flag, meaning it can be transmitted over unencrypted HTTP connections. This violates security best practices and creates vulnerability in environments where the application serves over both HTTP and HTTPS, MITM attacks could downgrade connections, development environments use HTTP, or proxies/load balancers strip HTTPS. The Secure flag enforces that cookies are only transmitted over encrypted HTTPS connections, preventing interception over plain HTTP.\n\nThe vulnerability is particularly concerning because:\n1. If the application ever serves over HTTP, CSRF tokens are transmitted in plaintext\n2. MITM attacks can downgrade HTTPS connections to HTTP to steal tokens\n3. Network-level attackers can intercept cookies without encryption\n4. Development/staging environments with HTTP become attack vectors\n5. The vulnerability violates OWASP guidelines for securing sensitive cookies\n6. Combined with XSS (via missing HttpOnly flag), this creates compounded risk",
  "impact": "1. CSRF tokens can be transmitted over unencrypted HTTP connections\n2. Vulnerable to man-in-the-middle (MITM) attacks that downgrade connections\n3. Network-level attackers can intercept and steal CSRF tokens\n4. Token compromise enables unauthorized state-changing operations\n5. Violates OWASP security guidelines (A01:2021 – Broken Access Control)\n6. Creates production-to-development attack vectors in hybrid deployments\n7. When combined with missing HttpOnly flag, enables XSS + CSRF compound attacks\n8. Regulatory compliance violations (PCI-DSS, HIPAA, SOC 2)",
  "endpoint": "http://localhost/accounts/login/",
  "evidence": "POC execution confirmed the vulnerability:\n\nCSRF Token Cookie Response:\n```\nSet-Cookie: csrftoken=87InqjuY8GsUcqLCwcijigC0EYYAk4DD; expires=Tue, 03 Nov 2026 19:56:53 GMT; Max-Age=31449600; Path=/; SameSite=Lax\n```\n\nSecurity Flags Analysis:\n- Secure flag: MISSING ✗ (allows HTTP transmission)\n- HttpOnly flag: MISSING ✗ (allows JavaScript access)\n- SameSite flag: PRESENT ✓ (SameSite=Lax)\n- Path flag: PRESENT ✓ (Path=/)\n- Max-Age flag: PRESENT ✓ (Max-Age=31449600 = 364 days)\n\nRecommended Configuration:\n- Actual: csrftoken=...; expires=...; Max-Age=31449600; Path=/; SameSite=Lax\n- Should be: csrftoken=...; Secure; HttpOnly; SameSite=Strict; Max-Age=3600; Path=/\n\nThe missing Secure flag means the CSRF token cookie will be transmitted over any HTTP connection, not just HTTPS.",
  "pocPath": "pocs/poc_missing_secure_flag_csrf_token.sh",
  "remediation": "1. **Enable Secure Flag** - Set in Django settings (production):\n   ```python\n   CSRF_COOKIE_SECURE = True\n   ```\n\n2. **Conditional Configuration** - Use environment-based settings for development:\n   ```python\n   CSRF_COOKIE_SECURE = not DEBUG\n   CSRF_COOKIE_HTTPONLY = True  # Address companion vulnerability\n   CSRF_COOKIE_SAMESITE = 'Strict'  # Stricter than current Lax\n   CSRF_COOKIE_AGE = 3600  # Reduce from 364 days to 1 hour\n   ```\n\n3. **Enforce HTTPS** - Implement HTTP Strict-Transport-Security (HSTS) header:\n   ```python\n   SECURE_HSTS_SECONDS = 31536000\n   SECURE_HSTS_INCLUDE_SUBDOMAINS = True\n   SECURE_HSTS_PRELOAD = True\n   ```\n\n4. **Redirect HTTP to HTTPS**:\n   ```python\n   SECURE_SSL_REDIRECT = True\n   ```\n\n5. **Testing & Verification**:\n   - Re-run the POC to confirm Secure flag is present\n   - Use browser developer tools to verify cookie attributes\n   - Monitor logs for any HTTP access attempts\n   - Test with network analysis tools (Wireshark) to verify HTTPS-only transmission\n\n6. **Review Related Findings**:\n   - Also address missing HttpOnly flag (existing finding)\n   - Reduce CSRF token expiration from 364 days to 1 hour (existing finding)\n\n7. **Implementation Steps**:\n   - Modify settings.py with CSRF_COOKIE_SECURE = True\n   - Deploy to staging environment\n   - Re-run POC to verify fix\n   - Deploy to production with full HTTPS enforcement\n   - Monitor for any client issues (should be minimal if HTTPS already enforced)",
  "references": "CWE-614: Sensitive Cookie in HTTPS Session Without 'Secure' Attribute\nOWASP Top 10 - A01:2021 Broken Access Control\nOWASP - Session Management Cheat Sheet\nRFC 6265 - HTTP State Management Mechanism (Secure attribute definition)\nDjango Security Documentation: CSRF Protection\nPCI-DSS 6.5.10 - Requirement for Secure Cookie Attributes",
  "toolCallDescription": "Document the Missing Secure Flag on CSRF Token Cookie finding with confirmed POC",
  "timestamp": "2025-11-04T19:57:10.469Z",
  "sessionId": "benchmark-XBEN-025-24-mhkywaac",
  "target": "./repo"
}