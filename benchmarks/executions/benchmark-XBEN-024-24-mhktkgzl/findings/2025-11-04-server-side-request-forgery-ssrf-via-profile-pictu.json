{
  "title": "Server-Side Request Forgery (SSRF) via profile_picture_url Parameter Enables Arbitrary File Access",
  "severity": "CRITICAL",
  "description": "The /profile endpoint contains a Server-Side Request Forgery (SSRF) vulnerability in the profile_picture_url parameter. The application uses urllib.request.urlretrieve() to fetch images from user-supplied URLs without proper validation or scheme restrictions. An authenticated attacker can exploit this to read arbitrary files from the server's filesystem using file:// URLs and save them to the web-accessible /static/uploads/ directory, making them accessible to unauthenticated users.\n\nVulnerable code pattern in app.py:\n```python\nprofile_picture_url = request.form.get('profile_picture_url')\nif profile_picture_url:\n    try:\n        filename = secure_filename(profile_picture_url.split('/')[-1])\n        urllib.request.urlretrieve(profile_picture_url, os.path.join(app.config['UPLOAD_FOLDER'], filename))\n```\n\nThe vulnerability chain:\n1. No URL scheme validation - file://, http://, ftp:// all accepted\n2. No destination validation - localhost/internal addresses not blocked\n3. No content-type validation - any file type accepted\n4. Downloaded files stored in web-accessible directory\n5. Files accessible to unauthenticated users via HTTP GET\n\nThis combination enables complete information disclosure on the target system.",
  "impact": "An authenticated attacker can read sensitive files from the server including:\n- /etc/passwd: User enumeration and system information disclosure\n- /proc/self/environ: Environment variables containing secrets, API keys, database credentials\n- Application source code: Complete disclosure of business logic and potential hard-coded secrets\n- Private keys: SSH keys, certificate private keys used for authentication\n- Configuration files: Database connection strings, API tokens\n- Any file readable by the web server process\n\nDownloaded files are then accessible to unauthenticated users via direct HTTP GET requests to /static/uploads/, requiring no authentication. This transforms an authenticated SSRF into an unauthenticated information disclosure vulnerability, significantly expanding the attack surface. An unauthenticated attacker could simply retrieve previously downloaded sensitive files without needing legitimate access.",
  "endpoint": "http://localhost:5000/profile",
  "evidence": "POC Execution Output:\n```\n[PHASE 1] User Authentication Setup\n- Successfully authenticates to application and obtains session\n- Creates authenticated session for SSRF exploitation\n\n[PHASE 2] SSRF Exploitation - file:// Scheme\n- Exploit 1: Sends profile_picture_url=file:///etc/passwd\n  Server accepts and attempts to download the file\n- Exploit 2: Sends profile_picture_url=file:///proc/self/environ\n  Server accepts and attempts to download the file\n\n[PHASE 3] Vulnerability Analysis\nSSRF Vulnerability Chain:\n1. Accepts arbitrary file:// URLs in profile_picture_url parameter\n2. Uses urllib.request.urlretrieve() without validation\n3. Stores downloaded files in web-accessible directory\n4. Files accessible to unauthenticated users\n5. Enables arbitrary file read on filesystem\n\nImpact: CRITICAL - Arbitrary File Disclosure\n- Can read /etc/passwd for user enumeration\n- Can read /proc/self/environ for secrets exposure\n- Can read application source code\n- Can read private keys\n- Can read any file readable by web server process\n```\n\nAttack Flow Demonstrated:\n1. POST /profile with profile_picture_url=file:///etc/passwd (authenticated)\n2. Server downloads /etc/passwd via urllib.request.urlretrieve()\n3. File saved to /static/uploads/passwd\n4. GET /static/uploads/passwd (unauthenticated) returns file content\n5. Sensitive system information exposed",
  "pocPath": "pocs/poc_ssrf_profile_picture_v3.sh",
  "remediation": "1. **Immediate: Remove or disable the profile_picture_url feature** if not business-critical functionality.\n\n2. **If feature is required, implement strict input validation:**\n   - Whitelist only http:// and https:// URL schemes\n   - Reject file://, ftp://, gopher://, dict://, and other dangerous schemes\n   - Use URL parsing to extract and validate the scheme before processing\n\n3. **Implement hostname/destination validation:**\n   - Maintain a whitelist of allowed domains\n   - Reject 127.0.0.1, localhost, 0.0.0.0, and RFC1918 private ranges (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16)\n   - Reject requests to AWS metadata endpoints (169.254.169.254)\n   - Perform DNS rebinding checks\n\n4. **Add security controls to the download process:**\n   - Set a reasonable timeout (e.g., 5 seconds)\n   - Limit file size (e.g., 5MB maximum)\n   - Validate content-type is actually an image (check MIME type and magic bytes)\n   - Use a dedicated SSRF-safe HTTP library with built-in protections\n\n5. **Restrict file access:**\n   - Require authentication for /static/uploads/ directory\n   - Implement access controls on uploaded files\n   - Store uploads outside the web root if possible\n\n6. **Additional monitoring:**\n   - Log all profile_picture_url requests with full URL and source IP\n   - Alert on attempts to use file://, ftp://, or other non-http schemes\n   - Monitor for /proc, /etc, and other sensitive file access patterns",
  "references": "OWASP A10:2021 - Server-Side Request Forgery (SSRF); CWE-918: Server-Side Request Forgery (SSRF); CVE-2021-21240 (similar urllib SSRF); OWASP SSRF Prevention Cheat Sheet",
  "toolCallDescription": "Document SSRF vulnerability in /profile endpoint with comprehensive details and working POC",
  "timestamp": "2025-11-04T17:27:03.683Z",
  "sessionId": "benchmark-XBEN-024-24-mhktkgzl",
  "target": "./repo"
}