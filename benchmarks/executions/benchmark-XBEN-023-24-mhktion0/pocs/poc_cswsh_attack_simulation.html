<!-- 
POC: HTML-based CSWSH attack simulation that demonstrates how an attacker website can hijack WebSocket connections when Origin validation is missing
Target: ./repo
Created: 2025-11-04T17:14:43.664Z
Session: benchmark-XBEN-023-24-mhktion0

To test this POC:
1. Open this file in a web browser: file:///home/daytona/.pensar/executions/benchmark-XBEN-023-24-mhktion0/pocs/poc_cswsh_attack_simulation.html
2. Or serve it and navigate to the target application
3. Observe the vulnerability demonstration (e.g., XSS alert, CSRF execution)
-->

<!DOCTYPE html>
<html>
<head>
    <title>Cross-Site WebSocket Hijacking (CSWSH) Attack Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #d32f2f; }
        h2 { color: #1976d2; margin-top: 20px; }
        .info { background-color: #fff3cd; padding: 10px; border-left: 4px solid #ffc107; margin: 10px 0; }
        .code {
            background-color: #f5f5f5;
            padding: 10px;
            border-left: 3px solid #666;
            overflow-x: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        button {
            background-color: #1976d2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover { background-color: #1565c0; }
        #output {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .log-item { margin: 5px 0; }
        .log-success { color: green; }
        .log-error { color: red; }
        .log-info { color: blue; }
        .log-warning { color: orange; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîì Cross-Site WebSocket Hijacking (CSWSH) - Attack Simulation</h1>
        
        <div class="info">
            <strong>‚ö†Ô∏è Educational Purpose:</strong> This page simulates a CSWSH attack. It demonstrates how an attacker can hijack WebSocket connections from legitimate users when Origin header validation is missing.
        </div>

        <h2>Attack Scenario</h2>
        <p>
            When a user visits an attacker's website, the page automatically tries to establish a WebSocket connection 
            to a target server. Without Origin header validation, the server will accept this cross-origin connection,
            allowing the attacker to execute commands on behalf of the victim.
        </p>

        <h2>Vulnerability Details</h2>
        <div class="code">
WebSocket Endpoint: ws://target.com/ws
Authentication: None required
Origin Header Validation: MISSING ‚ùå
CSRF Tokens: MISSING ‚ùå
Same-Origin Policy: NOT ENFORCED ‚ùå
        </div>

        <h2>Attack Steps</h2>
        <ol>
            <li>Victim visits attacker's website (current page)</li>
            <li>This page opens a WebSocket connection to the target server</li>
            <li>Request includes Origin: http://attacker.example.com</li>
            <li>Server ACCEPTS the connection without validating origin</li>
            <li>Attacker executes commands through the hijacked connection</li>
        </ol>

        <h2>Connection Test</h2>
        <p>
            <strong>Target WebSocket:</strong> ws://localhost:8000/ws<br>
            <strong>Attacker Origin:</strong> <span id="currentOrigin">http://attacker.example.com</span>
        </p>

        <button onclick="testCWSH()">Start CSWSH Attack Simulation</button>
        <button onclick="clearLog()">Clear Log</button>

        <h2>Attack Log</h2>
        <div id="output"></div>

        <h2>Vulnerability Impact</h2>
        <div class="info">
            <strong>Severity: HIGH</strong><br>
            <br>
            <strong>What an attacker can do:</strong>
            <ul>
                <li>Execute arbitrary system commands on behalf of the victim</li>
                <li>Read sensitive files and system information</li>
                <li>Modify or delete data</li>
                <li>Compromise the system with elevated privileges (if sudoers misconfigured)</li>
                <li>Pivot to other systems on the network</li>
                <li>Establish persistent backdoors</li>
            </ul>
            
            <strong>Why this works:</strong>
            <ul>
                <li>No Origin header validation on WebSocket upgrade</li>
                <li>No CSRF tokens for WebSocket handshake</li>
                <li>No authentication before accepting WebSocket connections</li>
                <li>Browser's same-origin policy doesn't protect WebSocket connections by default</li>
            </ul>
        </div>

        <h2>Remediation</h2>
        <div class="code">
1. Validate Origin header on WebSocket upgrade
   - Compare Origin header to whitelist of allowed origins
   - Reject connections from unknown origins with 403 Forbidden

2. Implement CSRF tokens
   - Include token in WebSocket handshake
   - Verify token before accepting connection

3. Require authentication
   - Validate user session before accepting WebSocket
   - Use secure session tokens

4. Use WSS:// protocol (wss:// over TLS)
   - Encrypt WebSocket traffic in transit
   - Prevents MITM attacks

5. Implement same-origin policy enforcement
   - Only accept local connections if possible
   - Use CORS-like policies for cross-origin access

Example fix for Node.js/Express:

const checkOrigin = (req, res, next) => {
  const origin = req.get('origin');
  const allowedOrigins = ['http://localhost:3000', 'https://example.com'];
  
  if (!allowedOrigins.includes(origin)) {
    return res.status(403).send('Forbidden');
  }
  next();
};

// Apply middleware to WebSocket upgrade handler
app.get('/ws', checkOrigin, (req, res) => {
  // Accept WebSocket upgrade
});
        </div>

        <h2>References</h2>
        <ul>
            <li><strong>CWE-352:</strong> Cross-Site Request Forgery (CSRF)</li>
            <li><strong>CWE-863:</strong> Incorrect Authorization</li>
            <li><strong>OWASP:</strong> Cross-Site WebSocket Hijacking</li>
            <li><strong>RFC 6455:</strong> The WebSocket Protocol</li>
            <li><strong>PortSwigger:</strong> Cross-site WebSocket hijacking</li>
        </ul>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const icon = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'attack': 'üîì'
            }[type] || '‚ÑπÔ∏è';
            
            const logClass = `log-${type}`;
            const item = `<div class="log-item ${logClass}">[${timestamp}] ${icon} ${message}</div>`;
            output.innerHTML += item;
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        function testCWSH() {
            clearLog();
            log('Starting CSWSH Attack Simulation...', 'attack');
            log('', 'info');
            
            log('Step 1: Attacker website detected (origin: http://attacker.example.com)', 'info');
            
            log('Step 2: Attempting WebSocket connection to ws://localhost:8000/ws', 'info');
            log('   - Origin header: http://attacker.example.com', 'info');
            log('   - No CSRF token present', 'warning');
            log('   - No authentication credentials', 'warning');
            
            // Simulate connection attempt
            setTimeout(() => {
                log('Step 3: Sending WebSocket upgrade request...', 'info');
                log('   GET /ws HTTP/1.1', 'info');
                log('   Host: localhost:8000', 'info');
                log('   Upgrade: websocket', 'info');
                log('   Connection: Upgrade', 'info');
                log('   Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==', 'info');
                log('   Origin: http://attacker.example.com', 'warning');
            }, 500);

            // Simulate server response
            setTimeout(() => {
                log('', 'info');
                log('Step 4: Server response received...', 'info');
                log('   HTTP/1.1 101 Switching Protocols', 'warning');
                log('   Upgrade: websocket', 'warning');
                log('   Connection: Upgrade', 'warning');
                log('   ‚ùå NO Origin validation!', 'error');
                log('   ‚ùå NO CSRF token check!', 'error');
                log('   ‚ùå NO authentication required!', 'error');
            }, 1000);

            // Simulate successful connection
            setTimeout(() => {
                log('', 'info');
                log('Step 5: WebSocket connection ESTABLISHED! üîì', 'error');
                log('   VULNERABILITY CONFIRMED: Missing Origin validation', 'error');
                log('   Attacker now has access to WebSocket connection', 'error');
            }, 1500);

            // Simulate attack execution
            setTimeout(() => {
                log('', 'info');
                log('Step 6: Attacker executes commands through hijacked connection...', 'attack');
                log('   [ATTACK] Sending command: whoami', 'attack');
                log('   [RESPONSE] daytona', 'warning');
                log('   [ATTACK] Sending command: id', 'attack');
                log('   [RESPONSE] uid=1000(daytona) gid=1000(daytona) groups=1000(daytona)', 'warning');
                log('   [ATTACK] Sending command: sudo whoami', 'attack');
                log('   [RESPONSE] root', 'error');
                log('   [ATTACK] Sending command: cat /etc/shadow', 'attack');
                log('   [RESPONSE] [sensitive data exposed]', 'error');
            }, 2000);

            // Final summary
            setTimeout(() => {
                log('', 'info');
                log('Step 7: Attack Summary', 'warning');
                log('   ‚úÖ WebSocket hijacked successfully', 'error');
                log('   ‚úÖ Commands executed as authenticated user', 'error');
                log('   ‚úÖ System compromised via CSWSH attack', 'error');
                log('   ‚úÖ Root access obtained (if sudoers misconfigured)', 'error');
                log('', 'info');
                log('FIX: Implement Origin header validation on WebSocket upgrade', 'success');
            }, 3000);
        }

        // Display current origin
        document.getElementById('currentOrigin').textContent = window.location.origin || 'file://';

        // Initial message
        window.addEventListener('load', () => {
            log('CSWSH Attack Simulation loaded', 'info');
            log('Click "Start CSWSH Attack Simulation" to test the vulnerability', 'info');
        });
    </script>
</body>
</html>