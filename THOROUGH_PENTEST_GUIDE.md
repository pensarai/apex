# Thorough Pentest Agent - User Guide

## Overview

The Thorough Pentest Agent is an intelligent orchestrator that coordinates multiple specialized security testing agents to perform comprehensive penetration testing engagements.

## When to Use

### Use Thorough Pentest (`/thorough`) when:

‚úÖ You're assessing an entire organization or domain  
‚úÖ You don't know the full attack surface  
‚úÖ You want automated asset discovery + deep testing  
‚úÖ You need comprehensive executive reporting  
‚úÖ You have time for a complete assessment

### Use Regular Pentest (`/pentest`) when:

‚úÖ You have a specific target URL/IP  
‚úÖ You know exactly what to test  
‚úÖ You want focused, deep testing  
‚úÖ Time is limited

## Quick Start

### 1. Launch Thorough Pentest

```
$ pensar
> /thorough
```

### 2. Provide Information

- **Target**: The organization or domain to assess (e.g., `example.com`)
- **Objective**: Your security goals (e.g., `Comprehensive security assessment of all assets`)

### 3. Begin Assessment

Press **ENTER** to start the orchestrator

### 4. Monitor Progress

Watch as the orchestrator:

1. üîç Discovers attack surface (all assets, services, endpoints)
2. üéØ Identifies high-value targets
3. ü§ñ Spawns pentest agents for selected targets
4. üìä Aggregates findings into comprehensive report

### 5. Review Results

- Press **ENTER** when complete to open the comprehensive report
- Or navigate to: `sessions/<session-id>/comprehensive-pentest-report.md`

## What Happens Behind the Scenes

### Phase 1: Attack Surface Discovery (10-30 minutes)

The orchestrator spawns an **Attack Surface Agent** that:

- Enumerates all domains and subdomains
- Identifies IP addresses and port ranges
- Discovers web applications, APIs, and services
- Identifies cloud resources (S3, Azure, GCS)
- Maps third-party integrations
- Categorizes assets by risk level
- Returns structured JSON with high-value targets

**Output**: `attack-surface-results.json`

### Phase 2: Strategic Testing (30 minutes - several hours)

The orchestrator reviews results and spawns **5-15 Pentest Agents** in parallel for:

- üî¥ CRITICAL priority targets (admin panels, exposed databases)
- üü† HIGH priority targets (authentication systems, APIs)
- üü° MEDIUM priority targets (main applications, portals)

Each agent performs deep security testing:

- Port scanning and service enumeration
- Web application vulnerability testing
- Authentication and authorization testing
- Business logic testing
- Configuration review

**Output**: Individual session directories with findings

### Phase 3: Reporting (5-10 minutes)

The orchestrator generates:

- Executive summary (for management)
- Complete asset inventory
- Aggregated findings by severity
- Attack surface analysis
- Prioritized recommendations
- Testing methodology documentation

**Output**: `comprehensive-pentest-report.md`

## Understanding the Results

### Attack Surface Results JSON

Located at: `sessions/<id>/attack-surface-results.json`

```json
{
  "summary": {
    "totalAssets": 127,
    "totalDomains": 15,
    "totalIPs": 8,
    "highValueTargets": 7
  },
  "discoveredAssets": {
    "domains": [...],
    "ipAddresses": [...],
    "webApplications": [...]
  },
  "highValueTargets": [
    {
      "target": "admin.example.com",
      "priority": "CRITICAL",
      "type": "admin_panel",
      "objective": "Test for auth bypass and privilege escalation",
      "rationale": "Exposed admin panel accessible from internet"
    }
  ]
}
```

### Comprehensive Report

Located at: `sessions/<id>/comprehensive-pentest-report.md`

Sections include:

1. **Executive Summary** - High-level overview for stakeholders
2. **Overall Risk Assessment** - Security posture analysis
3. **Key Findings** - Top 10-15 critical issues
4. **Recommendations** - Prioritized remediation guidance
5. **Sub-Agent Sessions** - Links to detailed findings

## Example Walkthrough

### Scenario: Assessing "Acme Corp"

```
> /thorough
Target: acme.com
Objective: Comprehensive security assessment before IPO
```

**Attack Surface Discovery finds:**

- 47 subdomains (including dev.acme.com, api.acme.com, admin.acme.com)
- 12 IP addresses across AWS and Azure
- 8 web applications
- 3 exposed S3 buckets
- Multiple API endpoints

**Orchestrator identifies 7 high-value targets:**

1. admin.acme.com (CRITICAL - admin panel)
2. api.acme.com (HIGH - main API)
3. dev.acme.com (HIGH - dev environment)
4. payment.acme.com (CRITICAL - payment processing)
5. auth.acme.com (HIGH - SSO system)
6. legacy.acme.com (MEDIUM - old application)
7. mobile-api.acme.com (HIGH - mobile backend)

**Orchestrator spawns 7 pentest agents in parallel**

**After 2-3 hours:**

- Attack surface report: 47 assets documented
- 7 detailed pentest reports
- 23 findings (4 critical, 7 high, 9 medium, 3 low)
- Comprehensive executive report generated

## Keyboard Shortcuts

### In Form View:

- **TAB** / **Shift+TAB**: Navigate fields
- **ENTER**: Begin assessment
- **ESC**: Cancel and return

### During Execution:

- **Ctrl+C**: Abort execution (safe)
- **ESC**: Return to main view (after abort)

### After Completion:

- **ENTER**: Open comprehensive report
- **ESC**: Close and return to main view

## Best Practices

### 1. Target Specification

**Good:**

- `example.com` - Domain for full org assessment
- `192.168.1.0/24` - Network range for internal assessment
- `Acme Corp` - Organization name for broad discovery

**Avoid:**

- `https://example.com/login` - Too specific (use `/pentest` instead)
- Multiple domains - Run separate assessments

### 2. Objective Writing

**Good:**

- "Comprehensive security assessment of all internet-facing assets"
- "Pre-acquisition security due diligence"
- "Annual penetration test covering web applications and infrastructure"

**Avoid:**

- "Test the website" - Too vague
- No objective - Provide context for prioritization

### 3. Time Management

- **Plan for 2-6 hours** depending on attack surface size
- Run overnight for large organizations
- Can be aborted and resumed later (sessions are saved)

### 4. Result Review

1. Read executive summary first (big picture)
2. Review high-value target selection (was prioritization correct?)
3. Check key findings (most critical issues)
4. Deep dive into individual pentest sessions (detailed findings)
5. Review attack surface JSON (asset inventory)

## Comparison with Regular Pentest

| Aspect              | Regular Pentest (`/pentest`) | Thorough Pentest (`/thorough`)      |
| ------------------- | ---------------------------- | ----------------------------------- |
| **Input**           | Single target                | Domain/organization                 |
| **Discovery**       | None (target known)          | Full attack surface analysis        |
| **Agents**          | 1 agent                      | 3-20 agents                         |
| **Duration**        | 15-60 minutes                | 2-6+ hours                          |
| **Output**          | Single report                | Comprehensive aggregated report     |
| **Depth**           | Very deep                    | Strategic depth on selected targets |
| **Breadth**         | Single target only           | All discovered assets               |
| **Best For**        | Known vulnerabilities        | Unknown attack surface              |
| **Report Audience** | Technical team               | Technical + Executive               |

## Troubleshooting

### Issue: "No high-value targets identified"

**Cause**: Attack surface agent didn't find interesting assets  
**Solution**: Check attack-surface-results.json - may need manual target selection

### Issue: "Agent execution failed"

**Cause**: Network issues, API limits, or target blocking  
**Solution**: Check session logs, retry with smaller scope

### Issue: "Report incomplete"

**Cause**: Some sub-agents may have failed  
**Solution**: Review individual session directories for partial results

### Issue: "Taking too long"

**Cause**: Large attack surface with many targets  
**Solution**: Abort (Ctrl+C) and use `/pentest` for specific targets instead

## Advanced Usage

### Reviewing Intermediate Results

While agents are running, you can inspect:

```bash
# View attack surface results
cat sessions/<id>/attack-surface-results.json | jq

# Monitor sub-agent sessions
ls sessions/<id>/subagents/

# View subagent messages
cat sessions/<id>/subagents/attack-surface-*/messages.json | jq
cat sessions/<id>/subagents/pentest-1-*/messages.json | jq

# View subagent metadata
cat sessions/<id>/subagents/*/metadata.json | jq

# View individual findings as they're discovered
watch -n 5 'ls -lrt sessions/<id>/findings/'

# Monitor all subagents
for dir in sessions/<id>/subagents/*/; do
  echo "=== $dir ==="
  cat "$dir/metadata.json" | jq '.type, .target'
done
```

### Customizing Target Selection

After attack surface analysis, you can:

1. Review `attack-surface-results.json`
2. Abort the thorough pentest (Ctrl+C)
3. Manually run `/pentest` for specific targets you want to focus on

### Analyzing Subagent Behavior

You can analyze what each subagent did by reviewing their messages:

```bash
# Count tools used by each subagent
for dir in sessions/<id>/subagents/*/; do
  echo "=== $(basename $dir) ==="
  cat "$dir/messages.json" | jq '[.[] | select(.role == "tool")] | length'
done

# Extract all tool calls from a specific subagent
cat sessions/<id>/subagents/pentest-1-*/messages.json | \
  jq '[.[] | select(.role == "tool") | {tool: .toolName, desc: .content}]'

# See what commands were executed
cat sessions/<id>/subagents/pentest-1-*/messages.json | \
  jq '.[] | select(.toolName == "execute_command") | .args.command'

# Track subagent progress over time
cat sessions/<id>/subagents/pentest-1-*/messages.json | \
  jq '.[] | select(.role == "assistant") | .content' | head -20
```

### Re-running Assessment

To re-assess the same target:

1. Note the previous session ID
2. Compare findings between runs
3. Track remediation progress
4. Review subagent message differences to see what changed

## Session Management

### Finding Past Assessments

```
> /sessions
```

Shows all previous thorough pentest sessions with:

- Target assessed
- Date/time
- Status (complete/aborted)
- Session path

### Session Structure

```
sessions/acme.com-2025-01-10-abc123/
  ‚îú‚îÄ‚îÄ comprehensive-pentest-report.md    # Main deliverable
  ‚îú‚îÄ‚îÄ attack-surface-results.json        # Structured asset data
  ‚îú‚îÄ‚îÄ session.json                        # Metadata
  ‚îú‚îÄ‚îÄ messages.json                       # Orchestrator agent messages
  ‚îú‚îÄ‚îÄ findings/                           # Attack surface findings
  ‚îú‚îÄ‚îÄ scratchpad/                         # Agent notes
  ‚îî‚îÄ‚îÄ subagents/                          # All subagent data
      ‚îú‚îÄ‚îÄ attack-surface-<session-id>/
      ‚îÇ   ‚îú‚îÄ‚îÄ messages.json               # Complete message history
      ‚îÇ   ‚îî‚îÄ‚îÄ metadata.json               # Subagent metadata
      ‚îú‚îÄ‚îÄ pentest-1-<session-id>/
      ‚îÇ   ‚îú‚îÄ‚îÄ messages.json               # Complete message history
      ‚îÇ   ‚îî‚îÄ‚îÄ metadata.json               # Subagent metadata
      ‚îú‚îÄ‚îÄ pentest-2-<session-id>/
      ‚îÇ   ‚îú‚îÄ‚îÄ messages.json               # Complete message history
      ‚îÇ   ‚îî‚îÄ‚îÄ metadata.json               # Subagent metadata
      ‚îî‚îÄ‚îÄ ...
```

Each subagent directory contains:

- **messages.json**: Complete conversation history including tool calls and results
- **metadata.json**: Subagent type, target, objective, timing, and session references

#### Subagent Messages Structure

The `messages.json` file in each subagent directory contains the complete conversation:

```json
[
  {
    "role": "user",
    "content": "Target: admin.example.com\nObjective: Test admin panel..."
  },
  {
    "role": "assistant",
    "content": "I'll conduct a comprehensive penetration test..."
  },
  {
    "role": "tool",
    "status": "completed",
    "toolCallId": "call_123",
    "content": "‚úì Scanning ports on target",
    "toolName": "execute_command",
    "args": {...}
  },
  ...
]
```

#### Subagent Metadata Structure

The `metadata.json` file provides context about each subagent:

```json
{
  "type": "pentest",
  "subagentId": "pentest-1-abc123",
  "target": "admin.example.com",
  "objective": "Test admin panel for authentication bypass",
  "sessionId": "xyz789",
  "sessionPath": "/path/to/subagent/session",
  "startTime": "2025-01-10T12:00:00.000Z",
  "endTime": "2025-01-10T12:45:00.000Z",
  "agentIndex": 1
}
```

This allows you to:

- Track which agent tested which target
- See timing and duration
- Link back to the original subagent session
- Replay or analyze agent behavior
- Debug issues with specific subagents

## Tips for Success

1. **Start Broad**: Use thorough pentest for initial assessment
2. **Follow Up Focused**: Use regular pentest for specific deep dives
3. **Read Executive Summary**: Great for stakeholder communication
4. **Track Over Time**: Compare results between assessments
5. **Use JSON Data**: Attack surface JSON useful for asset management
6. **Review Priorities**: Check if orchestrator selected appropriate targets
7. **Allow Time**: Don't rush - comprehensive testing takes time
8. **Save Reports**: Archive for compliance and tracking

## Security Considerations

‚ö†Ô∏è **Authorization Required**: Ensure you have written authorization to test all discovered assets

‚ö†Ô∏è **Scope Creep**: Attack surface discovery may find assets you don't own - verify before testing

‚ö†Ô∏è **Resource Usage**: Multiple parallel agents = higher network traffic and API usage

‚ö†Ô∏è **Data Sensitivity**: Reports may contain sensitive findings - store securely

## Getting Help

- View available commands: `/help`
- Check active sessions: `/sessions`
- Review AI models: `/models`
- Read architecture: See `src/core/agent/README.md`

## Summary

The Thorough Pentest Agent provides enterprise-grade automated penetration testing with intelligent orchestration, comprehensive coverage, and executive-level reporting. Use it when you need to understand and assess your entire attack surface, not just individual targets.

**Commands:**

- `/thorough` - Launch orchestrator (recommended)
- `/thorough-pentest` - Alias
- `/comprehensive` - Alias
