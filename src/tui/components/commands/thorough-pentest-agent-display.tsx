import { useState } from "react";
import { useKeyboard } from "@opentui/react";
import Input from "../input";
import { useCommand } from "../../command-provider";
import AgentDisplay from "../agent-display";
import useThoroughPentestAgent from "../hooks/thoroughPentestAgent";

export default function ThoroughPentestAgentDisplay() {
  const [focusedIndex, setFocusedIndex] = useState(0);
  const { closeThoroughPentest } = useCommand();

  // Header configuration state
  const [headerMode, setHeaderMode] = useState<'none' | 'default' | 'custom'>('default');
  const [customHeaders, setCustomHeaders] = useState<Record<string, string>>({});
  const [editingHeaderKey, setEditingHeaderKey] = useState('User-Agent');
  const [editingHeaderValue, setEditingHeaderValue] = useState('');

  // Use the custom hook for thorough pentest with subagent tracking
  const {
    target,
    setTarget,
    messages,
    hasStarted,
    isCompleted,
    sessionPath,
    subagents,
    abortController,
    isExecuting,
    beginExecution,
    openReport,
  } = useThoroughPentestAgent();

  const inputs = headerMode === 'custom'
    ? ["target", "headerMode", "customHeaderKey", "customHeaderValue"]
    : ["target", "headerMode"]; // List of input fields

  useKeyboard((key) => {
    // Escape - Close thorough pentest display
    if (key.name === "escape") {
      closeThoroughPentest();
      return;
    }

    // Ctrl+C - Abort execution if running
    if (key.ctrl && key.name === "c" && isExecuting && !isCompleted) {
      if (abortController) {
        abortController.abort();
      }
      return;
    }

    // Enter - View report when completed
    if (isCompleted && key.name === "return") {
      openReport();
      return;
    }

    // Don't allow navigation if streaming has started
    if (hasStarted) {
      return;
    }

    // Arrow Up/Down for radio buttons when focused on headerMode
    if (focusedIndex === 1 && key.name === 'up') {
      const modes: Array<'none' | 'default' | 'custom'> = ['none', 'default', 'custom'];
      const currentIndex = modes.indexOf(headerMode);
      setHeaderMode(modes[(currentIndex - 1 + 3) % 3]);
      return;
    }

    if (focusedIndex === 1 && key.name === 'down') {
      const modes: Array<'none' | 'default' | 'custom'> = ['none', 'default', 'custom'];
      const currentIndex = modes.indexOf(headerMode);
      setHeaderMode(modes[(currentIndex + 1) % 3]);
      return;
    }

    // Enter to add custom header (when in custom header fields)
    if (headerMode === 'custom' && (focusedIndex === 2 || focusedIndex === 3) && key.name === 'return') {
      if (editingHeaderKey && editingHeaderValue) {
        // Validate header name (alphanumeric and hyphens only)
        if (!/^[A-Za-z][A-Za-z0-9-]*$/.test(editingHeaderKey)) {
          // Invalid header name - just ignore for now
          return;
        }

        setCustomHeaders({ ...customHeaders, [editingHeaderKey]: editingHeaderValue });
        setEditingHeaderKey('');
        setEditingHeaderValue('');
      }
      return;
    }

    // Tab - Next field
    if (key.name === "tab" && !key.shift) {
      setFocusedIndex((prev) => (prev + 1) % inputs.length);
      return;
    }

    // Shift+Tab - Previous field
    if (key.name === "tab" && key.shift) {
      setFocusedIndex((prev) => (prev - 1 + inputs.length) % inputs.length);
      return;
    }

    // Enter - Begin execution (when all fields filled and not in header editing mode)
    if (key.name === "return" && focusedIndex < 2) {
      if (target) {
        const sessionConfig = {
          offensiveHeaders: {
            mode: headerMode,
            headers: headerMode === 'custom' ? customHeaders : undefined,
          },
        };
        beginExecution(sessionConfig);
      }
    }
  });

  // Otherwise, show the form
  return (
    <box
      alignItems="center"
      justifyContent="center"
      flexDirection="column"
      width="100%"
      maxHeight="100%"
      flexGrow={1}
      flexShrink={1}
      overflow="hidden"
      gap={1}
    >
      {hasStarted && (
        <AgentDisplay
          messages={messages}
          isStreaming={isExecuting}
          subagents={subagents}
        >
          {isCompleted && (
            <box
              border={true}
              borderColor="green"
              flexDirection="column"
              padding={1}
              gap={1}
              alignItems="center"
            >
              <text fg="green">✓ Pentest Completed</text>
              <text fg="white">
                Comprehensive report generated successfully
              </text>
              <text fg="gray">
                Attack surface analysis + multiple pentest agents
              </text>
              <box flexDirection="row" gap={1}>
                <text fg="gray">Press</text>
                <text fg="green">[ENTER]</text>
                <text fg="gray">to view report</text>
                <text fg="gray">or</text>
                <text fg="green">[ESC]</text>
                <text fg="gray">to close</text>
              </box>
              <text fg="gray">
                {sessionPath}/comprehensive-pentest-report.md
              </text>
            </box>
          )}
        </AgentDisplay>
      )}

      {!hasStarted && (
        <box flexDirection="column" width="50%" gap={1}>
          <text fg="green">Pentest</text>
          <text fg="white">
            Run a comprehensive penetration test with automated orchestration:
          </text>
          <text fg="gray">
            1. Attack surface analysis to discover all assets
          </text>
          <text fg="gray">
            2. Strategic spawning of pentest agents for high-value targets
          </text>
          <text fg="gray">3. Aggregated comprehensive reporting</text>
          <Input
            label="Target"
            onPaste={(text: string) => {
              const cleaned = String(text);
              setTarget((prev) => `${prev}${cleaned}`);
            }}
            description="The target organization/domain to assess"
            placeholder="example.com"
            value={target}
            onInput={setTarget}
            focused={focusedIndex === 0}
          />

          {/* Offensive Headers Configuration */}
          <box
            border={true}
            width="100%"
            borderStyle="heavy"
            backgroundColor="black"
            borderColor={focusedIndex === 1 ? "green" : "gray"}
            flexDirection="column"
            padding={1}
            gap={1}
          >
            <text fg="green">Offensive Request Headers</text>
            <text fg="gray">Configure headers for HTTP tools (curl, nmap, nikto, etc.)</text>

            {/* Radio buttons */}
            <box flexDirection="column" gap={0}>
              <box flexDirection="row" gap={1} alignItems="center">
                <text fg={headerMode === 'none' ? 'green' : 'gray'}>
                  {headerMode === 'none' ? '●' : '○'} None
                </text>
                <text fg="gray">(no custom headers)</text>
              </box>

              <box flexDirection="row" gap={1} alignItems="center">
                <text fg={headerMode === 'default' ? 'green' : 'gray'}>
                  {headerMode === 'default' ? '●' : '○'} Default
                </text>
                <text fg="gray">(User-Agent: pensar-apex)</text>
              </box>

              <box flexDirection="row" gap={1} alignItems="center">
                <text fg={headerMode === 'custom' ? 'green' : 'gray'}>
                  {headerMode === 'custom' ? '●' : '○'} Custom
                </text>
                <text fg="gray">(enter custom headers below)</text>
              </box>
            </box>

            {/* Custom headers editor (shown only in custom mode) */}
            {headerMode === 'custom' && (
              <box flexDirection="column" gap={1} paddingLeft={2}>
                <text fg="yellow">Custom Headers:</text>
                {Object.entries(customHeaders).map(([key, value]) => (
                  <text key={key} fg="gray">
                    {key}: {value}
                  </text>
                ))}

                <Input
                  label="Header Name"
                  description="e.g., User-Agent, X-Pentest-ID"
                  placeholder="User-Agent"
                  value={editingHeaderKey}
                  onInput={setEditingHeaderKey}
                  focused={focusedIndex === 2}
                />

                <Input
                  label="Header Value"
                  description="e.g., pensar-apex_client123"
                  placeholder="pensar-apex_myusername"
                  value={editingHeaderValue}
                  onInput={setEditingHeaderValue}
                  focused={focusedIndex === 3}
                />

                <text fg="gray">
                  Press <span fg="green">[ENTER]</span> to add header
                </text>
              </box>
            )}

            <text fg="gray">
              <span fg="green">[↑↓]</span> Select mode
            </text>
          </box>

          <box flexDirection="row" width="100%" gap={1}>
            <text fg="gray">
              <span fg="green">[TAB]</span> Next · <span fg="green">[ESC]</span>{" "}
              Close ·
            </text>
            <text fg="green">[ENTER]</text>
            <text fg="gray">Begin</text>
          </box>
          <box
            border={true}
            borderColor="yellow"
            padding={1}
            flexDirection="column"
          >
            <text fg="yellow">⚠️ Note: Thorough Pentest Mode</text>
            <text fg="gray">
              This will run multiple autonomous agents in sequence and may take
              significant time to complete.
            </text>
          </box>
        </box>
      )}
    </box>
  );
}
